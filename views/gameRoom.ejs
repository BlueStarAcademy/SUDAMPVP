<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUDAM - 대국실</title>
    <link rel="stylesheet" href="/css/modal.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-room {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-top: 20px;
        }

        .board-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #goBoard {
            border: 3px solid #8b4513;
            background: #deb887;
            cursor: crosshair;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
        }

        .player {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .player.black {
            background: #333;
            color: white;
        }

        .player.white {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #ddd;
        }

        .player.active {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .player-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .player-timer {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .player-timer.warning {
            color: #ff5722;
        }

        .player-timer.danger {
            color: #f44336;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .move-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .move-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .move-item:last-child {
            border-bottom: none;
        }

        .move-number {
            font-weight: 600;
            color: #666;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .game-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .game-status.waiting {
            background: #fff3e0;
            color: #f57c00;
        }

        .game-status.playing {
            background: #e8f5e9;
            color: #388e3c;
        }

        .game-status.finished {
            background: #e3f2fd;
            color: #1976d2;
        }

        .ai-thinking {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            color: #666;
            display: none;
        }

        .ai-thinking.active {
            display: block;
        }
    </style>
</head>
<body>
    <%- include('partials/header', { user: user }) %>

    <div class="container">
        <div class="game-room">
            <div class="board-section">
                <div class="board-container">
                    <div class="player-info">
                        <div class="player black" id="blackPlayer">
                            <div class="player-name" id="blackName"><%= blackPlayer ? blackPlayer.nickname : '흑' %></div>
                            <div style="font-size: 12px; opacity: 0.8;"><%= blackPlayer ? `레이팅: ${blackPlayer.rating}` : '' %></div>
                            <div class="player-timer" id="blackTimer">30:00</div>
                        </div>
                        <div class="player white" id="whitePlayer">
                            <div class="player-name" id="whiteName"><%= whitePlayer ? whitePlayer.nickname : '백' %></div>
                            <div style="font-size: 12px; opacity: 0.8;"><%= whitePlayer ? `레이팅: ${whitePlayer.rating}` : '' %></div>
                            <div class="player-timer" id="whiteTimer">30:00</div>
                        </div>
                    </div>

                    <canvas id="goBoard" width="600" height="600"></canvas>

                    <div class="ai-thinking" id="aiThinking">AI가 생각 중...</div>
                </div>
            </div>

            <div class="sidebar">
                <div class="info-panel">
                    <div class="panel-title">게임 정보</div>
                    <div class="game-status" id="gameStatus">대기 중</div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="passBtn">한 수 넘기기</button>
                        <button class="btn btn-secondary" id="scoreBtn">계가</button>
                        <button class="btn btn-danger" id="resignBtn">기권</button>
                    </div>
                </div>

                <div class="info-panel">
                    <div class="panel-title">수순</div>
                    <div class="move-list" id="moveList">
                        <!-- 수순이 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/modal.js"></script>
    <script src="/js/timer.js"></script>
    <script src="/js/game.js"></script>
    <script>
        const gameId = '<%= gameId %>';
        const socket = io();
        socket.emit('join_game', gameId);
        const currentUser = {
            id: '<%= user.id %>',
            nickname: '<%= user.nickname %>'
        };

        // Initialize game
        window.game = new GoGame('goBoard', socket, currentUser, gameId);
        window.timer = new GameTimer(socket, {
            blackTimer: 'blackTimer',
            whiteTimer: 'whiteTimer',
            blackPlayer: 'blackPlayer',
            whitePlayer: 'whitePlayer'
        });

        // Game events
        socket.on('game_state', (data) => {
            window.game.loadState(data);
            if (data.timers) {
                window.timer.updateTimers(data.timers);
            }
            
            // Update player names if needed
            if (data.game) {
                if (data.game.blackId === currentUser.id) {
                    document.getElementById('blackPlayer').classList.add('active');
                }
                if (data.game.whiteId === currentUser.id) {
                    document.getElementById('whitePlayer').classList.add('active');
                }
            }
            
            // Update game status
            if (data.game && !data.game.endedAt) {
                document.getElementById('gameStatus').textContent = '게임 중';
                document.getElementById('gameStatus').className = 'game-status playing';
            }
        });

        socket.on('move_made', (data) => {
            window.game.makeMove(data.move);
            updateMoveList(data.move);
        });

        socket.on('ai_move', (data) => {
            document.getElementById('aiThinking').classList.remove('active');
            window.game.makeMove(data.move);
            updateMoveList(data.move);
        });

        socket.on('ai_thinking', () => {
            document.getElementById('aiThinking').classList.add('active');
        });

        socket.on('timer_update', (data) => {
            window.timer.updateTimers(data);
        });

        socket.on('timer_expired', (data) => {
            alert(`${data.color === 'black' ? '흑' : '백'}의 시간이 초과되었습니다.`);
        });

        socket.on('game_ended', (data) => {
            document.getElementById('gameStatus').textContent = `게임 종료: ${data.result}`;
            document.getElementById('gameStatus').className = 'game-status finished';
        });

        socket.on('score_result', (data) => {
            Modal.open('scoreResult', `
                <h2>계가 결과</h2>
                <p>흑: ${data.blackScore}점</p>
                <p>백: ${data.whiteScore}점</p>
                <p>승자: ${data.winner === 'black' ? '흑' : '백'}</p>
            `);
        });

        // Button handlers
        document.getElementById('passBtn').addEventListener('click', () => {
            socket.emit('make_move', { move: { isPass: true } });
        });

        document.getElementById('scoreBtn').addEventListener('click', () => {
            socket.emit('request_score');
        });

        document.getElementById('resignBtn').addEventListener('click', () => {
            if (confirm('정말 기권하시겠습니까?')) {
                socket.emit('resign');
            }
        });

        function updateMoveList(move) {
            const moveList = document.getElementById('moveList');
            const moveItem = document.createElement('div');
            moveItem.className = 'move-item';
            moveItem.innerHTML = `
                <span class="move-number">${move.moveNumber}</span>
                <span>${move.color === 'black' ? '흑' : '백'}: ${move.isPass ? '한 수 넘김' : `${String.fromCharCode(65 + move.x)}${move.y + 1}`}</span>
            `;
            moveList.appendChild(moveItem);
            moveList.scrollTop = moveList.scrollHeight;
        }

        // Request initial game state
        socket.emit('get_game_state');
    </script>
</body>
</html>

