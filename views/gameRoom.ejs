<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SUDAM - 대국실</title>
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="stylesheet" href="/css/gameRoom.css">
</head>
<%
// 게임 모드에 따라 배경 클래스 추가 (기본값: strategic)
let modeClass = 'game-mode-strategic'; // 기본값
if (game && game.mode) {
    const gameMode = game.mode.toLowerCase();
    if (gameMode === 'playful' || gameMode === 'casual') {
        modeClass = 'game-mode-playful';
    }
}
%>
<body class="<%= modeClass %>">
    <div class="stadium-overlay"></div>

    <div class="game-container">
        <!-- 사이드바 오버레이 배경 -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <!-- 사이드바 토글 버튼 -->
        <button id="sidebarToggle" class="sidebar-toggle-btn" title="사이드바 접기/펼치기">
            <span class="toggle-icon">▶</span>
        </button>

        <!-- 좌측 컨텐츠 영역 -->
        <div class="left-content">
            <!-- 플레이어 패널 - 양쪽에 수평 배치, 바둑판 너비에 맞춤 -->
            <div class="player-panel-container" id="playerPanelContainer">
                <!-- 흑 패널 -->
                <%- include('partials/gameRoom/playerPanel', { player: blackPlayer, color: 'black', user: user, game: game }) %>
                <!-- 백 패널 -->
                <%- include('partials/gameRoom/playerPanel', { player: whitePlayer, color: 'white', user: user, game: game }) %>
            </div>
            <!-- 바둑판 섹션 -->
            <%- include('partials/gameRoom/boardSection') %>
        </div>

        <!-- 우측 사이드바 -->
        <div class="sidebar">
            <!-- 게임 정보 및 수순 패널 (같은 줄에 배치) -->
            <div class="info-panels-row">
                <!-- 게임 정보 패널 -->
                <%- include('partials/gameRoom/gameInfoPanel') %>

                <!-- 수순 패널 -->
                <%- include('partials/gameRoom/turnIndicatorPanel') %>
            </div>

            <!-- 유저 목록 패널 -->
            <%- include('partials/gameRoom/userListPanel', { blackPlayer: blackPlayer, whitePlayer: whitePlayer, user: user }) %>

            <!-- 채팅 패널 -->
            <%- include('partials/gameRoom/chatPanel') %>

            <!-- 매너액션 버튼 (PVP 게임에서만 표시, 게임 중에도 사용 가능) -->
            <%- include('partials/gameRoom/mannerActionsPanel') %>

            <!-- 나가기/일시정지 버튼 -->
            <button class="leave-button" id="leaveBtn" disabled>나가기</button>
            <button class="pause-button" id="pauseBtn" style="display: none;">일시정지</button>
        </div>

        <!-- Minigame Modal -->
        <%- include('partials/gameRoom/minigameModal') %>

        <!-- Stone Picking Modal (돌가리기 모달) -->
        <%- include('partials/gameRoom/stonePickingModal') %>

        <!-- Capture Bid Modal (덤 설정 모달) -->
        <%- include('partials/gameRoom/captureBidModal') %>

        <!-- Game Start Modal -->
        <%- include('partials/gameRoom/gameStartModal') %>

    <!-- 프로필 모달 -->
    <%- include('partials/profileModal') %>

    <!-- 공지사항 모달 -->
    <%- include('partials/noticeModal') %>

    <script>
        // EJS 변수를 window.gameRoomConfig로 전달 (gameRoom.js 로드 전에 실행되어야 함)
        <%
            // gameId를 안전하게 가져오기
            const safeGameId = gameId || (game && game.id) || '';
        %>
        window.gameRoomConfig = {
            gameId: '<%= safeGameId %>',
            currentUser: <%- JSON.stringify(user ? { id: user.id, nickname: user.nickname } : { id: '', nickname: '' }) %>,
            isAiGame: <%= game && game.isAiGame ? game.isAiGame : false %>,
            blackPlayerId: '<%= game && game.blackId ? game.blackId : "" %>',
            whitePlayerId: '<%= game && game.whiteId ? game.whiteId : "" %>',
            initialBoardSize: <%= typeof initialBoardSize !== 'undefined' ? initialBoardSize : 19 %>,
            initialGameMode: '<%= (game && game.mode) ? game.mode : "strategic" %>',
            blackPlayer: <%- JSON.stringify(blackPlayer || {}) %>,
            whitePlayer: <%- JSON.stringify(whitePlayer || {}) %>,
            game: <%- JSON.stringify(game || {}) %>
        };
        
        // 프로필 모달에서 사용할 전역 변수 설정
        window.currentUser = window.gameRoomConfig.currentUser;
        
        // 디버깅: 설정값 확인
        console.log('[Client] gameRoomConfig initialized:', {
            gameId: window.gameRoomConfig.gameId,
            currentUser: window.gameRoomConfig.currentUser,
            isAiGame: window.gameRoomConfig.isAiGame,
            gameMode: window.gameRoomConfig.game?.mode
        });
        
        // 디버깅: gameId 확인
        if (!window.gameRoomConfig.gameId || window.gameRoomConfig.gameId === '') {
            console.error('[Client] gameId is missing in config:', window.gameRoomConfig);
            // URL에서 gameId 추출 시도
            const urlMatch = window.location.pathname.match(/\/api\/game\/([^\/]+)/);
            if (urlMatch && urlMatch[1]) {
                window.gameRoomConfig.gameId = urlMatch[1];
                console.log('[Client] Extracted gameId from URL:', window.gameRoomConfig.gameId);
            }
        }
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/modal.js"></script>
    <script src="/js/timer.js"></script>
    <script src="/js/game.js"></script>
    <script src="/js/profileModal.js"></script>
    <script src="/js/gameRoom.js"></script>

</body>
</html>
