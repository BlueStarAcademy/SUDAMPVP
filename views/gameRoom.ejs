<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUDAM - 대국실</title>
    <link rel="stylesheet" href="/css/modal.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e; /* 기본 배경색 */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }
        
        /* 게임 모드에 따른 배경 이미지 */
        body.game-mode-playful {
            background-image: url('/images/playfulbg.webp') !important;
        }
        
        body.game-mode-strategic {
            background-image: url('/images/strategicbg.webp') !important;
        }
        
        /* 배경 이미지 위에 오버레이 추가 (가독성 향상) */
        .stadium-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: -1;
            pointer-events: none;
        }
        
        /* 배경 이미지가 다른 요소들 뒤에 보이도록 z-index 조정 */
        .game-container,
        .sidebar {
            position: relative;
            z-index: 1;
        }

        .game-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 320px;
            grid-template-rows: 1fr;
            gap: 20px;
            padding: 30px;
            max-width: 1400px;
            margin: auto;
            width: 95%;
            aspect-ratio: 16 / 9;
            max-height: calc(100vh - 100px);
            min-height: 0;
            overflow: hidden;
            box-sizing: border-box;
            position: relative;
            /* 배경이 선명하게 보이도록 블러 제거 및 투명도 조정 */
            background: rgba(0, 0, 0, 0.45);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            z-index: 1;
            transition: grid-template-columns 0.3s ease;
        }

        /* 사이드바가 접혔을 때의 레이아웃 */
        .game-container.sidebar-collapsed {
            grid-template-columns: 1fr 0px;
            gap: 0;
        }
        
        /* 플레이어 패널 - 양쪽에 수평 배치, 바둑판 너비와 정확히 맞춤 */
        .player-panel-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 12px;
            flex-shrink: 0;
            height: auto;
            min-height: 80px;
            width: 100%;
            max-width: min(calc(100vw - 400px), 900px);
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        .player-panel {
            flex: 1;
            display: flex;
            align-items: stretch;
            gap: 8px;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.3s;
            border: 2px solid;
        }

        /* 흑은 따낸 돌이 오른쪽, 백은 왼쪽 (대칭) */
        .player-panel.black {
            flex-direction: row;
        }

        .player-panel.white {
            flex-direction: row-reverse;
        }


        .player-panel.black {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.7) 0%, rgba(30, 30, 30, 0.7) 100%);
            border-color: rgba(100, 100, 100, 0.5);
        }

        .player-panel.white {
            background: linear-gradient(135deg, rgba(240, 240, 240, 0.9) 0%, rgba(220, 220, 220, 0.9) 100%);
            border-color: rgba(150, 150, 150, 0.5);
        }

        .player-panel.active {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
            border-color: rgba(59, 130, 246, 0.8);
        }

        /* 턴 표시 박스 (수순) */
        .turn-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: clamp(4rem, 12vmin, 6rem);
            height: 100%;
            padding: 8px;
            background: rgba(17, 24, 39, 0.9);
            border-radius: 12px;
            border: 2px solid rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .turn-label {
            font-size: clamp(0.5rem, 1.5vmin, 0.7rem);
            font-weight: 600;
            color: rgba(156, 163, 175, 1);
            margin-bottom: 4px;
        }

        .turn-number {
            font-family: 'Courier New', monospace;
            font-size: clamp(1.5rem, 6vmin, 2.5rem);
            font-weight: 700;
            color: #fbbf24;
            line-height: 1;
        }

        .turn-color {
            font-size: clamp(0.7rem, 2vmin, 0.9rem);
            font-weight: 600;
            color: rgba(209, 213, 219, 1);
            margin-top: 4px;
        }

        .player-info-section {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
            gap: 4px;
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 백 패널의 헤더는 정방향 (닉네임/레이팅이 왼쪽, 아바타가 오른쪽) */
        .player-panel.white .player-header {
            flex-direction: row;
            justify-content: space-between;
        }

        .player-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-details {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        /* 백 패널의 세부 정보는 왼쪽 정렬 (흑과 반대) */
        .player-panel.white .player-details {
            align-items: flex-start;
            text-align: left;
        }
        
        .player-name-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 백 패널의 이름 행은 왼쪽 정렬 (닉네임, 티어 순서 유지) */
        .player-panel.white .player-name-row {
            flex-direction: row;
            justify-content: flex-start;
        }

        .player-name {
            font-size: clamp(0.8rem, 3vmin, 1.125rem);
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-panel.black .player-name {
            color: white;
        }

        .player-panel.white .player-name {
            color: black;
        }

        .tier-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .tier-icon-small {
            width: 16px;
            height: 16px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .player-level {
            font-size: clamp(0.6rem, 2vmin, 0.75rem);
            opacity: 0.8;
        }

        .player-panel.black .player-level {
            color: rgba(255, 255, 255, 0.7);
        }

        .player-panel.white .player-level {
            color: rgba(0, 0, 0, 0.7);
        }

        .timer-section {
            margin-top: 4px;
        }

        .timer-bar {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 4px;
        }

        .player-panel.white .timer-bar {
            background: rgba(0, 0, 0, 0.1);
        }

        .timer-bar-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.2s linear;
        }

        .timer-bar-fill.warning {
            background: #f59e0b;
        }

        .timer-bar-fill.danger {
            background: #ef4444;
            animation: pulse-bar 1s infinite;
        }

        @keyframes pulse-bar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timer-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 4px;
        }

        .timer-text {
            font-family: 'Courier New', monospace;
            font-size: clamp(1rem, 3.5vmin, 1.25rem);
            font-weight: 700;
        }

        .player-panel.black .timer-text {
            color: rgba(255, 255, 255, 0.9);
        }

        .player-panel.white .timer-text {
            color: rgba(0, 0, 0, 0.9);
        }

        .timer-text.warning {
            color: #f59e0b;
        }

        .timer-text.danger {
            color: #ef4444;
        }

        .captured-stones {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: clamp(4.5rem, 16vmin, 6rem);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid;
            flex-shrink: 0;
        }

        .player-panel.black .captured-stones {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.9) 0%, rgba(0, 0, 0, 0.9) 100%);
            border-color: rgba(100, 100, 100, 0.6);
        }

        .player-panel.white .captured-stones {
            background: linear-gradient(135deg, rgba(250, 250, 250, 0.95) 0%, rgba(230, 230, 230, 0.95) 100%);
            border-color: rgba(150, 150, 150, 0.6);
        }

        .captured-label {
            font-size: clamp(0.6rem, 2vmin, 0.75rem);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .player-panel.black .captured-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .player-panel.white .captured-label {
            color: rgba(0, 0, 0, 0.7);
        }

        .captured-count {
            font-family: 'Courier New', monospace;
            font-size: clamp(1rem, 5vmin, 2rem);
            font-weight: 700;
        }

        .player-panel.black .captured-count {
            color: white;
        }

        .player-panel.white .captured-count {
            color: black;
        }

        /* 바둑판 섹션 */
        .board-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: transparent;
            gap: 0;
            width: 100%;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .board-wrapper {
            position: relative;
            width: 100%;
            /* 반응형: 화면 크기에 따라 조정되되, 최대 900px */
            max-width: min(calc(100vw - 450px), calc(100vh - 420px), 800px);
            aspect-ratio: 1;
            flex-shrink: 1;
            min-width: 0;
            margin: 0 auto;
        }
        
        /* 전광판 - 바둑판과 버튼 패널 사이 */
        .game-notice-board {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 0;
            margin: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            flex-shrink: 0;
            width: 100%;
            max-width: min(calc(100vw - 450px), 800px); /* 바둑판 너비와 맞춤 */
            box-sizing: border-box;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 버튼 패널 - 화면 하단에 고정 */
        .button-panel {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            padding: 12px;
            background: rgba(17, 24, 39, 0.95);
            border-radius: 0 0 12px 12px; /* 하단 모서리만 둥글게 */
            border: 1px solid rgba(75, 85, 99, 0.5);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            width: 100%;
            max-width: min(calc(100vw - 450px), 800px); /* 바둑판 너비와 맞춤 */
            box-sizing: border-box;
            margin: 0;
        }
        
        .button-group {
            display: flex;
            flex-direction: row;
            gap: 12px;
            align-items: center;
        }

        /* 좌측: 대국 기능 버튼 그룹 */
        .button-group-left {
            justify-content: flex-start;
            flex: 1;
        }

        /* 우측: 특수 기능 버튼 그룹 */
        .button-group-right {
            justify-content: flex-end;
            flex: 1;
        }

        .game-btn {
            width: 56px;
            height: 56px;
            padding: 0;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        /* 버튼 이미지 스타일 */
        .game-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        /* 텍스트만 있는 버튼 (이미지가 없을 때) */
        .game-btn:not(:has(img)) {
            font-size: 20px;
        }
        
        .game-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            margin-bottom: 8px;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .game-btn:hover::after {
            opacity: 1;
        }

        .game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-pass {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-pass:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-resign {
            background: #ef4444;
            color: white;
        }

        .btn-resign:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-special {
            background: rgba(75, 85, 99, 0.8);
            color: white;
            border: 1px solid rgba(107, 114, 128, 0.5);
        }

        .btn-special:hover:not(:disabled) {
            background: rgba(107, 114, 128, 0.9);
            border-color: rgba(107, 114, 128, 0.8);
        }

        #goBoard {
            width: 100%;
            height: 100%;
            border: 4px solid #1f2937;
            background: #e0b484;
            cursor: crosshair;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: block;
            object-fit: contain;
        }

        .ai-thinking {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            color: white;
            display: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            animation: pulse 2s infinite;
            z-index: 10;
        }

        .ai-thinking.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* 좌측 컨텐츠 영역 (플레이어 패널, 바둑판, 버튼패널) */
        .left-content {
            grid-column: 1;
            grid-row: 1 / -1;
            display: flex;
            flex-direction: column;
            gap: 15px; /* 요소들 사이 간격 */
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            height: 100%;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }
        
        /* 바둑판 섹션 */
        .board-section-wrapper {
            width: 100%;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            padding-bottom: 0;
            align-self: stretch;
        }

        /* 사이드바 */
        .sidebar {
            grid-column: 2;
            grid-row: 1 / -1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(17, 24, 39, 0.8);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(75, 85, 99, 0.5);
            align-self: stretch;
            height: 100%;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease, width 0.3s ease;
            position: relative;
        }

        /* 사이드바가 접혔을 때 */
        .sidebar-collapsed .sidebar {
            transform: translateX(340px);
            opacity: 0;
            pointer-events: none;
            width: 0;
            padding: 0;
            margin: 0;
            border: none;
        }

        /* 사이드바 토글 버튼 */
        .sidebar-toggle-btn {
            position: absolute;
            right: 330px; /* 사이드바 바로 왼쪽 */
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 60px;
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-right: none;
            border-radius: 8px 0 0 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s ease;
            padding: 0;
        }

        .sidebar-toggle-btn:hover {
            background: rgba(59, 130, 246, 0.8);
        }

        .sidebar-collapsed .sidebar-toggle-btn {
            right: 10px;
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 8px;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .sidebar-collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .settings-button {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(75, 85, 99, 0.6);
            border: 1px solid rgba(107, 114, 128, 0.5);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(209, 213, 219, 1);
            font-size: 16px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .settings-button:hover {
            background: rgba(107, 114, 128, 0.8);
            border-color: rgba(107, 114, 128, 0.8);
            transform: rotate(90deg);
        }

        .settings-button svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .info-panel {
            background: rgba(31, 41, 55, 0.8);
            border-radius: 8px;
            padding: 12px;
            flex-shrink: 0;
            border: 1px solid rgba(75, 85, 99, 0.5);
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #fbbf24;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(75, 85, 99, 0.7);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .panel-title-with-settings {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 8px;
        }

        .panel-title-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title-text::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #667eea;
            border-radius: 2px;
        }

        .game-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap-x: 12px;
            gap-y: 4px;
            font-size: 12px;
        }

        .game-info-label {
            font-weight: 600;
            color: rgba(156, 163, 175, 1);
        }

        .game-info-value {
            color: rgba(209, 213, 219, 1);
            white-space: nowrap;
        }

        .user-list {
            max-height: 150px;
            overflow-y: auto;
            space-y: 4px;
        }

        .user-list::-webkit-scrollbar {
            width: 6px;
        }

        .user-list::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 10px;
        }

        .user-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 6px;
            margin-bottom: 4px;
            background: rgba(17, 24, 39, 0.5);
        }

        .user-item:hover {
            background: rgba(31, 41, 55, 0.7);
        }

        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .user-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .edit-profile-btn {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: rgba(59, 130, 246, 0.9);
            border: 1px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        .user-item:hover .edit-profile-btn {
            opacity: 1;
        }
        
        .edit-profile-btn:hover {
            background: rgba(37, 99, 235, 1);
            transform: scale(1.1);
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: rgba(209, 213, 219, 1);
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-role {
            font-size: 12px;
            color: rgba(156, 163, 175, 1);
            flex-shrink: 0;
        }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: rgba(31, 41, 55, 0.8);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(75, 85, 99, 0.5);
        }

        .chat-tabs {
            display: flex;
            background: rgba(17, 24, 39, 0.7);
            padding: 4px;
            border-radius: 6px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .chat-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(156, 163, 175, 1);
        }

        .chat-tab.active {
            background: #3b82f6;
            color: white;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            space-y: 4px;
            margin-bottom: 12px;
            background: rgba(17, 24, 39, 0.4);
            padding: 8px;
            border-radius: 6px;
            min-height: 0;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .chat-message {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .chat-message-system {
            color: #fbbf24;
        }

        .chat-message-user {
            color: rgba(209, 213, 219, 1);
        }

        .chat-message-user .username {
            font-weight: 600;
            color: rgba(156, 163, 175, 1);
            cursor: pointer;
        }

        .chat-message-user .username:hover {
            text-decoration: underline;
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .emoji-btn {
            padding: 8px 12px;
            background: #667eea;
            border: 2px solid #5568d3;
            color: white;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            border: none;
        }

        .emoji-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
            min-width: 0;
        }

        .chat-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.6);
            border-radius: 6px;
            color: rgba(209, 213, 219, 1);
            font-size: 12px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .chat-send-btn {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: #2563eb;
        }

        .chat-send-btn:disabled {
            background: rgba(75, 85, 99, 0.5);
            cursor: not-allowed;
        }

        /* 이모지 팝업 */
        .emoji-popup {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 350px;
            max-height: 0;
            height: 280px;
            z-index: 10001;
            overflow: hidden;
            display: none;
            flex-direction: column;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease, max-height 0.3s ease;
            border: 1px solid #e0e0e0;
            box-sizing: border-box;
        }
        
        .chat-input-container {
            position: relative;
            overflow: visible;
        }

        .emoji-popup.show {
            display: flex;
            max-height: 280px;
            opacity: 1;
            transform: translateY(0);
        }

        .emoji-popup-header {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            background: #f9f9f9;
            flex-shrink: 0;
        }

        .emoji-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }

        .emoji-tab:hover {
            background: #f0f0f0;
        }

        .emoji-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .emoji-popup-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .emoji-section {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            min-height: 0;
        }

        .emoji-section.active {
            display: flex;
            flex-direction: column;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            height: fit-content;
            /* 5열 3행 (15개) - aspect-ratio: 1이므로 그리드 열 너비에 따라 높이 결정, 여유있게 설정 */
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .emoji-item {
            font-size: 24px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            user-select: none;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
            box-sizing: border-box;
        }

        .emoji-item:hover {
            background: #f0f0f0;
        }

        .quick-message-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            height: 100%;
        }

        .quick-message-btn {
            padding: 10px 15px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            transition: all 0.2s;
        }

        .quick-message-btn:hover {
            background: #e8e8e8;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
            margin-top: 12px;
        }

        .leave-button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(75, 85, 99, 0.8);
            color: white;
        }

        .leave-button:enabled {
            background: #3b82f6;
        }

        .leave-button:enabled:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .leave-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pause-button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #f59e0b;
            color: white;
        }

        .pause-button:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(75, 85, 99, 0.8);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(107, 114, 128, 0.8);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* 반응형 디자인 - 모든 컨텐츠가 같은 비율로 줄어들도록 */
        @media (max-width: 1400px) {
            .game-container {
                grid-template-columns: minmax(0, 900px) minmax(0, 280px);
                max-width: 100%;
                padding: clamp(8px, 2vw, 20px);
                gap: clamp(6px, 1.5vw, 12px);
                box-sizing: border-box;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            .player-panel-container {
                max-width: 100%;
                gap: clamp(6px, 1.5vw, 12px);
                box-sizing: border-box;
            }
            
            .board-wrapper {
                max-width: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                max-height: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                box-sizing: border-box;
            }
            
            .button-panel {
                max-width: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                padding: clamp(10px, 2vw, 16px);
                gap: clamp(12px, 2vw, 24px);
                box-sizing: border-box;
            }
            
            .button-group {
                gap: clamp(8px, 1.5vw, 12px);
            }
            
            .button-group-left {
                justify-content: flex-start;
                flex: 1;
            }
            
            .button-group-right {
                justify-content: flex-end;
                flex: 1;
            }
            
            .game-btn {
                width: clamp(48px, 10vw, 56px);
                height: clamp(48px, 10vw, 56px);
                font-size: clamp(16px, 3vw, 20px);
            }
            
            .sidebar {
                padding: clamp(8px, 1.5vw, 12px);
                gap: clamp(6px, 1vw, 8px);
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .info-panel {
                padding: clamp(8px, 1.5vw, 12px);
                box-sizing: border-box;
            }
        }

        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                padding: clamp(8px, 2vw, 16px);
                gap: clamp(6px, 1.5vw, 10px);
                box-sizing: border-box;
                overflow: hidden;
            }
            
            .player-panel-container {
                grid-column: 1;
                grid-row: 1;
                max-width: 100%;
                gap: clamp(6px, 1.5vw, 12px);
                box-sizing: border-box;
            }
            
            .left-content {
                grid-column: 1;
                grid-row: 2;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .board-wrapper {
                max-width: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                max-height: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                box-sizing: border-box;
            }
            
            .button-panel {
                max-width: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                padding: clamp(8px, 1.5vw, 12px);
                gap: clamp(12px, 2vw, 20px);
                box-sizing: border-box;
            }
            
            .button-group-left {
                justify-content: flex-start;
                flex: 1;
            }
            
            .button-group-right {
                justify-content: flex-end;
                flex: 1;
            }
            
            .sidebar {
                grid-column: 1;
                grid-row: 3;
                padding: clamp(8px, 1.5vw, 12px);
                gap: clamp(6px, 1vw, 8px);
                box-sizing: border-box;
                min-height: 0;
            }
        }

        @media (max-width: 968px) {
            .game-container {
                padding: clamp(6px, 1.5vw, 12px);
                gap: clamp(4px, 1vw, 8px);
                box-sizing: border-box;
                overflow: hidden;
            }

            .sidebar {
                grid-column: 1;
                grid-row: 1;
                order: -1;
                padding: clamp(8px, 1.5vw, 12px);
                gap: clamp(6px, 1vw, 8px);
                box-sizing: border-box;
                min-height: 0;
            }

            .player-panel-container {
                flex-direction: column;
                gap: clamp(4px, 1vw, 8px);
                box-sizing: border-box;
            }

            .board-section-wrapper {
                max-width: 100%;
            }
            
            .board-wrapper {
                max-width: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                max-height: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                box-sizing: border-box;
            }
            
            .button-panel {
                max-width: min(calc(100vw - 380px), calc(100vh - 320px), 900px);
                padding: clamp(8px, 1.5vw, 12px);
                gap: clamp(12px, 2vw, 20px);
                box-sizing: border-box;
                flex-direction: row;
            }
            
            .button-group {
                gap: clamp(8px, 1.5vw, 12px);
            }
            
            .button-group-left {
                justify-content: flex-start;
                flex: 1;
            }
            
            .button-group-right {
                justify-content: flex-end;
                flex: 1;
            }
            
            .game-btn {
                width: clamp(48px, 12vw, 56px);
                height: clamp(48px, 12vw, 56px);
                font-size: clamp(14px, 3vw, 18px);
                flex-shrink: 0;
            }
        }

        @media (max-width: 640px) {
            .game-container {
                padding: clamp(4px, 1vw, 8px);
                gap: clamp(3px, 0.8vw, 6px);
            }

            .player-panel {
                padding: clamp(4px, 1vw, 6px);
                gap: clamp(4px, 1vw, 6px);
            }

            .player-avatar {
                width: clamp(28px, 7vw, 32px);
                height: clamp(28px, 7vw, 32px);
                font-size: clamp(12px, 3vw, 14px);
            }

            .captured-stones {
                width: clamp(2.5rem, 12vw, 3rem);
                padding: clamp(3px, 0.8vw, 4px);
            }
            
            .turn-indicator {
                width: clamp(3rem, 10vw, 5rem);
                padding: clamp(4px, 1vw, 6px);
            }
            
            .board-section-wrapper {
                max-width: 100%;
            }
            
            .board-wrapper {
                max-width: min(calc(100vw - 50px), calc(100vh - 320px), 900px);
                max-height: min(calc(100vw - 50px), calc(100vh - 320px), 900px);
            }
            
            .button-panel {
                max-width: min(calc(100vw - 50px), calc(100vh - 320px), 900px);
                flex-direction: row;
                gap: clamp(12px, 2vw, 16px);
                padding: clamp(8px, 2vw, 12px);
            }
            
            .button-group {
                width: 100%;
                justify-content: center;
                gap: clamp(6px, 1.5vw, 10px);
                flex-wrap: wrap;
            }
            
            .button-group-left,
            .button-group-right {
                justify-content: center;
                width: 100%;
            }
            
            .game-btn {
                width: clamp(44px, 11vw, 52px);
                height: clamp(44px, 11vw, 52px);
                flex-shrink: 0;
            }
        }
        /* 대국 결과 모달 스타일 */
        .result-modal-content {
            width: 500px !important;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
            border: 2px solid #667eea !important;
            color: white !important;
            padding: 0 !important;
            overflow: hidden !important;
            border-radius: 20px !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }

        .result-header {
            padding: 30px;
            text-align: center;
            background: rgba(102, 126, 234, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: white;
        }

        .result-winner {
            font-size: 20px;
            color: #fbbf24;
            font-weight: 600;
        }

        .result-body {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .result-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .result-stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .reward-section {
            margin-top: 10px;
            padding: 20px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .reward-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .reward-icon {
            font-size: 24px;
        }

        .reward-value {
            font-size: 18px;
            font-weight: 700;
            color: #fbbf24;
        }

        .result-actions {
            padding: 0 30px 30px;
            display: flex;
            gap: 15px;
        }

        .result-actions .btn {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-home {
            background: #4b5563;
            color: white;
        }

        .btn-home:hover {
            background: #374151;
        }

        .btn-retry {
            background: #667eea;
            color: white;
        }

        .btn-retry:hover {
            background: #5a67d8;
        }

        .win-text { color: #4ade80 !important; }
        .lose-text { color: #f87171 !important; }
        .draw-text { color: #94a3b8 !important; }
    </style>
</head>
<body<%
// 게임 모드에 따라 배경 클래스 추가 (기본값: strategic)
let modeClass = 'game-mode-strategic'; // 기본값
if (game && game.mode) {
    if (game.mode === 'playful' || game.mode === 'casual') {
        modeClass = 'game-mode-playful';
    } else if (game.mode === 'strategic') {
        modeClass = 'game-mode-strategic';
    }
}
%> class="<%= modeClass %>">
    <%- include('partials/header', { user: user }) %>
    <div class="stadium-overlay"></div>

    <div class="game-container">
        <!-- 사이드바 토글 버튼 -->
        <button id="sidebarToggle" class="sidebar-toggle-btn" title="사이드바 접기/펼치기">
            <span class="toggle-icon">▶</span>
        </button>

        <!-- 좌측 컨텐츠 영역 -->
        <div class="left-content">
            <!-- 플레이어 패널 - 양쪽에 수평 배치, 바둑판 너비에 맞춤 -->
            <div class="player-panel-container">
            <!-- 흑 패널 (따낸 돌이 오른쪽) -->
            <div class="player-panel black" id="blackPlayer">
                <div class="player-info-section">
                        <div class="player-header">
                            <div class="player-avatar" id="blackAvatar" data-avatar="<%= blackPlayer && blackPlayer.avatar ? blackPlayer.avatar : '1' %>" data-user-id="<%= blackPlayer ? blackPlayer.id : '' %>">
                                <% if (blackPlayer && blackPlayer.avatar) { %>
                                <img src="/images/profile<%= blackPlayer.avatar %>.webp" alt="<%= blackPlayer.nickname %>" onerror="this.style.display='none'; this.parentElement.textContent='<%= blackPlayer.nickname.charAt(0).toUpperCase() %>';">
                                <% } else { %>
                                <%= blackPlayer ? blackPlayer.nickname.charAt(0).toUpperCase() : '흑' %>
                                <% } %>
                            </div>
                        <div class="player-details">
                            <div class="player-name-row">
                                <div class="player-name" id="blackName"><%= blackPlayer ? blackPlayer.nickname : '흑' %></div>
                                <% 
                                if (blackPlayer && blackPlayer.rating) {
                                    const rating = blackPlayer.rating;
                                    let tier = 1;
                                    if (rating >= 2400) tier = 9;
                                    else if (rating >= 2200) tier = 8;
                                    else if (rating >= 2000) tier = 7;
                                    else if (rating >= 1800) tier = 6;
                                    else if (rating >= 1600) tier = 5;
                                    else if (rating >= 1400) tier = 4;
                                    else if (rating >= 1200) tier = 3;
                                    else if (rating >= 1000) tier = 2;
                                %>
                                <img src="/images/tire<%= tier %>.webp" alt="티어<%= tier %>" class="tier-icon" onerror="this.style.display='none';">
                                <% } %>
                            </div>
                            <div class="player-level" id="blackRating">레이팅: <%= blackPlayer ? blackPlayer.rating : '1500' %></div>
                        </div>
                    </div>
                    <div class="timer-section">
                        <div class="timer-bar">
                            <div class="timer-bar-fill" id="blackTimerBar" style="width: 100%"></div>
                        </div>
                        <div class="timer-display">
                            <span class="timer-text" id="blackTimer">30:00</span>
                        </div>
                    </div>
                </div>
                <div class="captured-stones">
                    <div class="captured-label">따낸 돌</div>
                    <div class="captured-count" id="blackCaptured">0</div>
                </div>
            </div>

            <!-- 턴 표시 박스 (수순) -->
            <div class="turn-indicator" id="turnIndicator">
                <div class="turn-label">수순</div>
                <div class="turn-number" id="turnNumber">0</div>
                <div class="turn-color" id="turnColor">-</div>
            </div>

            <!-- 백 패널 (따낸 돌이 왼쪽) -->
            <div class="player-panel white" id="whitePlayer">
                <div class="captured-stones">
                    <div class="captured-label">따낸 돌</div>
                    <div class="captured-count" id="whiteCaptured">0</div>
                </div>
                <div class="player-info-section">
                    <div class="player-header">
                        <div class="player-details">
                            <div class="player-name-row">
                                <div class="player-name" id="whiteName"><%= whitePlayer ? whitePlayer.nickname : '백' %></div>
                                <% 
                                if (whitePlayer && whitePlayer.rating) {
                                    const rating = whitePlayer.rating;
                                    let tier = 1;
                                    if (rating >= 2400) tier = 9;
                                    else if (rating >= 2200) tier = 8;
                                    else if (rating >= 2000) tier = 7;
                                    else if (rating >= 1800) tier = 6;
                                    else if (rating >= 1600) tier = 5;
                                    else if (rating >= 1400) tier = 4;
                                    else if (rating >= 1200) tier = 3;
                                    else if (rating >= 1000) tier = 2;
                                %>
                                <img src="/images/tire<%= tier %>.webp" alt="티어<%= tier %>" class="tier-icon" onerror="this.style.display='none';">
                                <% } %>
                            </div>
                            <div class="player-level" id="whiteRating">레이팅: <%= whitePlayer ? whitePlayer.rating : '1500' %></div>
                        </div>
                        <div class="player-avatar" id="whiteAvatar" data-avatar="<%= whitePlayer && whitePlayer.avatar ? whitePlayer.avatar : '1' %>" data-user-id="<%= whitePlayer ? whitePlayer.id : '' %>">
                            <% if (whitePlayer && whitePlayer.avatar) { %>
                            <img src="/images/profile<%= whitePlayer.avatar %>.webp" alt="<%= whitePlayer.nickname %>" onerror="this.style.display='none'; this.parentElement.textContent='<%= whitePlayer.nickname.charAt(0).toUpperCase() %>';">
                            <% } else { %>
                            <%= whitePlayer ? whitePlayer.nickname.charAt(0).toUpperCase() : '백' %>
                            <% } %>
                        </div>
                    </div>
                    <div class="timer-section">
                        <div class="timer-bar">
                            <div class="timer-bar-fill" id="whiteTimerBar" style="width: 100%"></div>
                        </div>
                        <div class="timer-display">
                            <span class="timer-text" id="whiteTimer">30:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <!-- 바둑판 섹션 -->
            <div class="board-section-wrapper">
                <div class="board-section">
                    <div class="board-wrapper">
                        <canvas id="goBoard" width="900" height="900"></canvas>
                        <div class="ai-thinking" id="aiThinking">AI가 생각 중...</div>
                    </div>
                    
                    <!-- 전광판 - 게임 상태 안내 -->
                    <div class="game-notice-board" id="gameNoticeBoard">
                        게임이 시작되었습니다.
                    </div>
                    
                    <!-- 버튼 패널 - 바둑판 하단에 붙어서 움직임 -->
                    <div class="button-panel">
                        <!-- 좌측: 대국 기능 버튼 (패스, 기권) -->
                        <div class="button-group button-group-left">
                            <button class="game-btn btn-pass" id="passBtn" data-tooltip="통과" title="통과">
                                <img src="/images/pass.webp" alt="통과" onerror="this.style.display='none'; this.parentElement.innerHTML='⏭️';">
                            </button>
                            <button class="game-btn btn-resign" id="resignBtn" data-tooltip="기권" title="기권">
                                <img src="/images/giveup.webp" alt="기권" onerror="this.style.display='none'; this.parentElement.innerHTML='🏳️';">
                            </button>
                        </div>
                        
                        <!-- 우측: 특수 기능 버튼 (형세판단, 힌트 등) -->
                        <div class="button-group button-group-right" id="specialButtons">
                            <!-- 버튼들은 게임 모드에 따라 동적으로 표시됨 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 우측 사이드바 -->
        <div class="sidebar">
            <!-- 게임 정보 패널 -->
            <div class="info-panel">
                <div class="panel-title">
                    <div class="panel-title-with-settings">
                        <div class="panel-title-text">대국 정보</div>
                        <button class="settings-button" id="settingsBtn" title="설정">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.4-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                    <div class="game-info-grid">
                        <div class="game-info-label">게임 모드:</div>
                        <div class="game-info-value" id="gameMode">일반</div>
                        <div class="game-info-label">판 크기:</div>
                        <div class="game-info-value">19x19</div>
                        <div class="game-info-label">제한시간:</div>
                        <div class="game-info-value">30분</div>
                        <div class="game-info-label">상태:</div>
                        <div class="game-info-value" id="gameStatus">대기 중</div>
                    </div>
                </div>

                <!-- 유저 목록 패널 -->
                <div class="info-panel">
                    <div class="panel-title">
                        <div class="panel-title-text">유저 목록</div>
                    </div>
                    <div class="user-list" id="userList">
                        <div class="user-item">
                            <div class="user-avatar-small"><%= blackPlayer ? blackPlayer.nickname.charAt(0).toUpperCase() : '흑' %></div>
                            <div class="user-name"><%= blackPlayer ? blackPlayer.nickname : '흑' %></div>
                            <div class="user-role">흑</div>
                        </div>
                        <div class="user-item">
                            <div class="user-avatar-small"><%= whitePlayer ? whitePlayer.nickname.charAt(0).toUpperCase() : '백' %></div>
                            <div class="user-name"><%= whitePlayer ? whitePlayer.nickname : '백' %></div>
                            <div class="user-role">백</div>
                        </div>
                    </div>
                </div>

                <!-- 채팅 패널 -->
                <div class="chat-panel">
                    <div class="chat-tabs">
                        <div class="chat-tab active" data-tab="game">대국실</div>
                        <div class="chat-tab" data-tab="global">전체채팅</div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message chat-message-system">대국실에 오신 것을 환영합니다!</div>
                    </div>
                    <div class="chat-input-container">
                        <button class="emoji-btn" id="emojiBtn" title="이모지 및 퀵 메시지">😊</button>
                        <div class="chat-input-wrapper">
                            <input type="text" class="chat-input" id="chatInput" placeholder="메시지 입력..." maxlength="200">
                        </div>
                        <button class="chat-send-btn" id="chatSendBtn">전송</button>
                        <!-- 이모지 및 퀵 메시지 팝업 -->
                        <div class="emoji-popup" id="emojiPopup">
                            <div class="emoji-popup-header">
                                <button class="emoji-tab active" data-tab="emoji">이모지</button>
                                <button class="emoji-tab" data-tab="quick">퀵 메시지</button>
                            </div>
                            <div class="emoji-popup-content">
                                <div class="emoji-section active" id="emojiSection">
                                    <div class="emoji-grid">
                                        <span class="emoji-item">😊</span><span class="emoji-item">😄</span><span class="emoji-item">😁</span><span class="emoji-item">😆</span><span class="emoji-item">😅</span>
                                        <span class="emoji-item">🤣</span><span class="emoji-item">🙂</span><span class="emoji-item">🙃</span><span class="emoji-item">😉</span><span class="emoji-item">😌</span>
                                        <span class="emoji-item">😍</span><span class="emoji-item">🥰</span><span class="emoji-item">😘</span><span class="emoji-item">😗</span><span class="emoji-item">😙</span>
                                        <span class="emoji-item">😚</span><span class="emoji-item">😋</span><span class="emoji-item">😛</span><span class="emoji-item">😝</span><span class="emoji-item">😜</span>
                                        <span class="emoji-item">🤪</span><span class="emoji-item">🤨</span><span class="emoji-item">🧐</span><span class="emoji-item">🤓</span><span class="emoji-item">😎</span>
                                        <span class="emoji-item">🤩</span><span class="emoji-item">🥳</span><span class="emoji-item">😏</span><span class="emoji-item">😒</span><span class="emoji-item">😞</span>
                                        <span class="emoji-item">😔</span><span class="emoji-item">😟</span><span class="emoji-item">😕</span><span class="emoji-item">🙁</span><span class="emoji-item">☹️</span>
                                        <span class="emoji-item">😣</span><span class="emoji-item">😖</span><span class="emoji-item">😫</span><span class="emoji-item">😩</span><span class="emoji-item">🥺</span>
                                        <span class="emoji-item">😢</span><span class="emoji-item">😭</span><span class="emoji-item">😤</span><span class="emoji-item">😠</span><span class="emoji-item">😡</span>
                                        <span class="emoji-item">🤬</span><span class="emoji-item">🤯</span><span class="emoji-item">😳</span><span class="emoji-item">🥵</span><span class="emoji-item">🥶</span>
                                        <span class="emoji-item">😱</span><span class="emoji-item">😨</span><span class="emoji-item">😰</span><span class="emoji-item">😥</span><span class="emoji-item">😓</span>
                                        <span class="emoji-item">🤗</span><span class="emoji-item">🤔</span><span class="emoji-item">🤭</span><span class="emoji-item">🤫</span><span class="emoji-item">🤥</span>
                                        <span class="emoji-item">😶</span><span class="emoji-item">😐</span><span class="emoji-item">😑</span><span class="emoji-item">😬</span><span class="emoji-item">🙄</span>
                                        <span class="emoji-item">😯</span><span class="emoji-item">😦</span><span class="emoji-item">😧</span><span class="emoji-item">😮</span><span class="emoji-item">😲</span>
                                        <span class="emoji-item">👍</span><span class="emoji-item">👎</span><span class="emoji-item">👌</span><span class="emoji-item">✌️</span><span class="emoji-item">🤞</span>
                                    </div>
                                </div>
                                <div class="emoji-section" id="quickSection">
                                    <div class="quick-message-list">
                                        <button class="quick-message-btn">안녕하세요!</button>
                                        <button class="quick-message-btn">좋은 수네요!</button>
                                        <button class="quick-message-btn">고수시네요!</button>
                                        <button class="quick-message-btn">잘하시네요!</button>
                                        <button class="quick-message-btn">좋은 게임이었습니다!</button>
                                        <button class="quick-message-btn">다음에 또 하죠!</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 나가기/일시정지 버튼 -->
                <button class="leave-button" id="leaveBtn" disabled>나가기</button>
                <button class="pause-button" id="pauseBtn" style="display: none;">일시정지</button>
            </div>
        </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/modal.js"></script>
    <script src="/js/timer.js"></script>
    <script src="/js/game.js"></script>
    <script>
        const gameId = '<%= gameId %>';
        const socket = io();
        socket.emit('join_game', gameId);
        const currentUser = {
            id: '<%= user.id %>',
            nickname: '<%= user.nickname %>'
        };
        const isAiGame = <%= game.isAiGame || false %>;
        let gameEnded = false;
        let isPaused = false;
        
        // 초기 게임 모드에 따른 배경 이미지 설정
        const initialGameMode = '<%= (game && game.mode) ? game.mode : "strategic" %>';
        
        function updateBackgroundImage(mode) {
            const body = document.body;
            if (mode === 'playful' || mode === 'casual') {
                body.classList.remove('game-mode-strategic');
                body.classList.add('game-mode-playful');
            } else {
                body.classList.remove('game-mode-playful');
                body.classList.add('game-mode-strategic');
            }
        }

        // 페이지 로드 시 즉시 배경 이미지 적용
        updateBackgroundImage(initialGameMode);

        // Initialize game
        window.game = new GoGame('goBoard', socket, currentUser, gameId);

        // 사이드바 토글 기능
        const sidebarToggle = document.getElementById('sidebarToggle');
        const gameContainer = document.querySelector('.game-container');
        
        sidebarToggle?.addEventListener('click', () => {
            gameContainer.classList.toggle('sidebar-collapsed');
            // 바둑판 크기 재계산 (레이아웃 변경 대응)
            setTimeout(() => {
                if (window.game && typeof window.game.resize === 'function') {
                    window.game.resize();
                }
            }, 300);
        });
        window.timer = new GameTimer(socket, {
            blackTimer: 'blackTimer',
            whiteTimer: 'whiteTimer',
            blackPlayer: 'blackPlayer',
            whitePlayer: 'whitePlayer'
        });

        // 타이머 바 업데이트 함수
        function updateTimerBar(color, timeLeft, totalTime) {
            const barId = color === 'black' ? 'blackTimerBar' : 'whiteTimerBar';
            const timerId = color === 'black' ? 'blackTimer' : 'whiteTimer';
            const bar = document.getElementById(barId);
            const timer = document.getElementById(timerId);
            
            if (bar && timer) {
                const percent = (timeLeft / totalTime) * 100;
                bar.style.width = Math.max(0, Math.min(100, percent)) + '%';
                
                // 경고 상태 설정
                if (timeLeft < 60) {
                    bar.classList.add('danger');
                    timer.classList.add('danger');
                } else if (timeLeft < 300) {
                    bar.classList.add('warning');
                    timer.classList.add('warning');
                } else {
                    bar.classList.remove('warning', 'danger');
                    timer.classList.remove('warning', 'danger');
                }
            }
        }

        // 턴 표시 업데이트
        function updateTurnIndicator(moveNumber, currentColor) {
            const turnNumberEl = document.getElementById('turnNumber');
            const turnColorEl = document.getElementById('turnColor');
            if (turnNumberEl) turnNumberEl.textContent = moveNumber || 0;
            if (turnColorEl) turnColorEl.textContent = currentColor === 'black' ? '흑' : (currentColor === 'white' ? '백' : '-');
        }

        // 특수 기능 버튼 표시 (게임 모드에 따라)
        function updateSpecialButtons(gameMode) {
            const specialButtons = document.getElementById('specialButtons');
            if (!specialButtons) return;
            
            specialButtons.innerHTML = '';
            
            // 기본 버튼들 (일반 게임)
            const buttons = [
                { id: 'scoreBtn', text: '형세판단', mode: 'all' },
                { id: 'hintBtn', text: '힌트', mode: 'all' },
            ];
            
            // 특수 모드별 버튼
            if (gameMode === 'hidden' || gameMode === 'mix') {
                buttons.push({ id: 'hiddenBtn', text: '히든', mode: 'hidden' });
                buttons.push({ id: 'scanBtn', text: '스캔', mode: 'hidden' });
            }
            if (gameMode === 'missile' || gameMode === 'mix') {
                buttons.push({ id: 'missileBtn', text: '미사일', mode: 'missile' });
            }
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'game-btn btn-special';
                button.id = btn.id;
                button.setAttribute('data-tooltip', btn.text);
                button.title = btn.text;
                
                // 이미지 파일명 매핑
                const imageMap = {
                    'scoreBtn': 'see.webp',
                    'hintBtn': 'hint.webp',
                    'hiddenBtn': 'hidden.webp',
                    'scanBtn': 'scan.webp',
                    'missileBtn': 'missile.webp'
                };
                
                const imgFileName = imageMap[btn.id];
                if (imgFileName) {
                    const img = document.createElement('img');
                    img.src = `/images/${imgFileName}`;
                    img.alt = btn.text;
                    img.onerror = function() {
                        this.style.display = 'none';
                        button.textContent = btn.text;
                    };
                    button.appendChild(img);
                } else {
                    // 이미지가 없으면 텍스트로 표시
                    button.textContent = btn.text;
                }
                
                button.addEventListener('click', () => {
                    handleSpecialButton(btn.id);
                });
                specialButtons.appendChild(button);
            });
        }

        function handleSpecialButton(buttonId) {
            switch(buttonId) {
                case 'scoreBtn':
                    socket.emit('request_score');
                    break;
                case 'hintBtn':
                    socket.emit('request_hint');
                    break;
                case 'hiddenBtn':
                    socket.emit('use_hidden');
                    break;
                case 'scanBtn':
                    socket.emit('use_scan');
                    break;
                case 'missileBtn':
                    socket.emit('use_missile');
                    break;
            }
        }

        // 나가기/일시정지 버튼 업데이트
        function updateLeaveButton() {
            const leaveBtn = document.getElementById('leaveBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isAiGame && !gameEnded) {
                // AI 게임 중: 일시정지 버튼 표시
                leaveBtn.style.display = 'none';
                pauseBtn.style.display = 'block';
            } else {
                // 일반 게임 또는 게임 종료: 나가기 버튼 표시
                leaveBtn.style.display = 'block';
                pauseBtn.style.display = 'none';
                
                // 게임 종료 시에만 활성화
                leaveBtn.disabled = !gameEnded;
            }
        }

        // 아바타 선택 모달 열기
        function openAvatarSelector() {
            let avatarHTML = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px;">';
            
            for (let i = 1; i <= 35; i++) {
                avatarHTML += `
                    <button class="avatar-select-btn" data-avatar="${i}" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; padding: 0; overflow: hidden; background: transparent; transition: all 0.2s;">
                        <img src="/images/profile${i}.webp" alt="Profile ${i}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.textContent='${i}'; this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; this.parentElement.style.color='white'; this.parentElement.style.display='flex'; this.parentElement.style.alignItems='center'; this.parentElement.style.justifyContent='center'; this.parentElement.style.fontSize='20px'; this.parentElement.style.fontWeight='bold';">
                    </button>
                `;
            }
            
            avatarHTML += '</div>';
            
            Modal.open('avatarSelector', avatarHTML, {
                title: '프로필 아바타 선택',
                width: '500px'
            });
            
            // 아바타 선택 버튼 이벤트 리스너 추가
            setTimeout(() => {
                document.querySelectorAll('.avatar-select-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const avatarNum = btn.dataset.avatar;
                        socket.emit('update_avatar', { avatar: parseInt(avatarNum) });
                        Modal.close('avatarSelector');
                    });
                    
                    btn.addEventListener('mouseenter', () => {
                        btn.style.borderColor = '#3b82f6';
                        btn.style.transform = 'scale(1.1)';
                    });
                    
                    btn.addEventListener('mouseleave', () => {
                        btn.style.borderColor = 'transparent';
                        btn.style.transform = 'scale(1)';
                    });
                });
            }, 100);
        }
        
        // 티어 계산 함수 (레이팅에 따라)
        function getTierFromRating(rating) {
            if (rating < 1000) return 1; // 새싹
            if (rating < 1200) return 2; // 루키
            if (rating < 1400) return 3; // 브론즈
            if (rating < 1600) return 4; // 실버
            if (rating < 1800) return 5; // 골드
            if (rating < 2000) return 6; // 플래티넘
            if (rating < 2200) return 7; // 다이아
            if (rating < 2400) return 8; // 마스터
            return 9; // 챌린저
        }
        
        // 티어 이미지 업데이트
        function updateTierIcon(element, rating, size = 'normal') {
            const tier = getTierFromRating(rating);
            const className = size === 'small' ? 'tier-icon-small' : 'tier-icon';
            const existingIcon = element.querySelector(`.${className}`);
            if (existingIcon) {
                existingIcon.src = `/images/tire${tier}.webp`;
            } else {
                const icon = document.createElement('img');
                icon.src = `/images/tire${tier}.webp`;
                icon.alt = `티어${tier}`;
                icon.className = className;
                icon.onerror = function() { this.style.display = 'none'; };
                element.appendChild(icon);
            }
        }
        
        // 아바타 업데이트
        function updateAvatar(userId, avatarNumber) {
            // 플레이어 패널 아바타 업데이트
            const blackAvatar = document.getElementById('blackAvatar');
            const whiteAvatar = document.getElementById('whiteAvatar');
            
            if (blackAvatar && blackAvatar.dataset.userId === userId) {
                blackAvatar.dataset.avatar = avatarNumber;
                const img = blackAvatar.querySelector('img');
                if (img) {
                    img.src = `/images/profile${avatarNumber}.webp`;
                    img.onerror = function() {
                        this.style.display = 'none';
                        blackAvatar.textContent = userId.charAt(0).toUpperCase();
                    };
                } else {
                    blackAvatar.innerHTML = `<img src="/images/profile${avatarNumber}.webp" alt="Avatar" onerror="this.style.display='none'; this.parentElement.textContent='${userId.charAt(0).toUpperCase()}';" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
            }
            
            if (whiteAvatar && whiteAvatar.dataset.userId === userId) {
                whiteAvatar.dataset.avatar = avatarNumber;
                const img = whiteAvatar.querySelector('img');
                if (img) {
                    img.src = `/images/profile${avatarNumber}.webp`;
                    img.onerror = function() {
                        this.style.display = 'none';
                        whiteAvatar.textContent = userId.charAt(0).toUpperCase();
                    };
                } else {
                    whiteAvatar.innerHTML = `<img src="/images/profile${avatarNumber}.webp" alt="Avatar" onerror="this.style.display='none'; this.parentElement.textContent='${userId.charAt(0).toUpperCase()}';" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
            }
            
            // 유저 목록 아바타 업데이트
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                if (item.dataset.userId === userId) {
                    const avatarEl = item.querySelector('.user-avatar-small');
                    if (avatarEl) {
                        avatarEl.dataset.avatar = avatarNumber;
                        const existingEditBtn = avatarEl.querySelector('.edit-profile-btn');
                        const img = avatarEl.querySelector('img');
                        if (img) {
                            img.src = `/images/profile${avatarNumber}.webp`;
                            img.onerror = function() {
                                this.style.display = 'none';
                                avatarEl.textContent = userId.charAt(0).toUpperCase();
                                if (existingEditBtn) {
                                    avatarEl.appendChild(existingEditBtn);
                                }
                            };
                        } else {
                            avatarEl.innerHTML = `<img src="/images/profile${avatarNumber}.webp" alt="Avatar" onerror="this.style.display='none'; this.parentElement.textContent='${userId.charAt(0).toUpperCase()}';" style="width: 100%; height: 100%; object-fit: cover;">`;
                            if (existingEditBtn) {
                                avatarEl.appendChild(existingEditBtn);
                            }
                        }
                    }
                }
            });
        }
        
        // 전광판 업데이트 함수
        function updateGameNotice(message) {
            const noticeBoard = document.getElementById('gameNoticeBoard');
            if (noticeBoard) {
                noticeBoard.textContent = message;
            }
        }

        // Game events
        socket.on('game_state', (data) => {
            window.game.loadState(data);
            if (data.timers) {
                window.timer.updateTimers(data.timers);
                if (data.timers.blackTime !== undefined) {
                    updateTimerBar('black', data.timers.blackTime, 30 * 60);
                }
                if (data.timers.whiteTime !== undefined) {
                    updateTimerBar('white', data.timers.whiteTime, 30 * 60);
                }
            }
            
            // Update player names if needed
            if (data.game) {
                // 내 턴인지 확인
                const currentColor = data.currentColor || 'black';
                let isMyTurn = false;
                
                if (data.game.isAiGame) {
                    // AI 게임인 경우: AI가 아닌 플레이어의 턴일 때만 true
                    const aiColor = data.game.aiColor || 'white';
                    if (currentColor === 'black' && aiColor !== 'black' && data.game.blackId === currentUser.id) {
                        isMyTurn = true;
                    } else if (currentColor === 'white' && aiColor !== 'white' && data.game.whiteId === currentUser.id) {
                        isMyTurn = true;
                    }
                } else {
                    // 일반 게임인 경우
                    isMyTurn = (currentColor === 'black' && data.game.blackId === currentUser.id) ||
                               (currentColor === 'white' && data.game.whiteId === currentUser.id);
                }
                
                window.game.isMyTurn = isMyTurn;
                
                // 전광판 업데이트 - 현재 턴 표시
                if (!data.game.endedAt) {
                    const turnText = currentColor === 'black' ? '흑' : '백';
                    const myTurnText = isMyTurn ? ' (내 차례)' : ' (상대 차례)';
                    updateGameNotice(`${turnText}의 차례입니다.${myTurnText}`);
                }
                
                if (data.game.blackId === currentUser.id) {
                    document.getElementById('blackPlayer').classList.add('active');
                    document.getElementById('whitePlayer').classList.remove('active');
                }
                if (data.game.whiteId === currentUser.id) {
                    document.getElementById('whitePlayer').classList.add('active');
                    document.getElementById('blackPlayer').classList.remove('active');
                }
                
                // 티어 아이콘 업데이트
                if (data.game.blackRating !== undefined) {
                    const blackNameRow = document.querySelector('#blackName')?.parentElement;
                    if (blackNameRow) {
                        updateTierIcon(blackNameRow, data.game.blackRating, 'normal');
                    }
                }
                if (data.game.whiteRating !== undefined) {
                    const whiteNameRow = document.querySelector('#whiteName')?.parentElement;
                    if (whiteNameRow) {
                        updateTierIcon(whiteNameRow, data.game.whiteRating, 'normal');
                    }
                }
                
                // 게임 모드에 따른 배경 이미지 업데이트
                if (data.game.mode) {
                    updateBackgroundImage(data.game.mode);
                    document.getElementById('gameMode').textContent = data.game.mode === 'playful' || data.game.mode === 'casual' ? '놀이바둑' : (data.game.mode === 'strategic' ? '전략바둑' : '일반');
                }
            }
            
            // Update game status
            if (data.game && !data.game.endedAt) {
                document.getElementById('gameStatus').textContent = '게임 중';
                gameEnded = false;
            } else {
                gameEnded = true;
                if (data.game && data.game.endedAt) {
                    updateGameNotice('게임이 종료되었습니다.');
                }
            }
            
            // 턴 표시 업데이트
            updateTurnIndicator(data.moveNumber || 0, data.currentColor || 'black');
            
            // 포획 돌 수 업데이트
            if (data.capturedBlack !== undefined) {
                document.getElementById('blackCaptured').textContent = data.capturedBlack || 0;
            }
            if (data.capturedWhite !== undefined) {
                document.getElementById('whiteCaptured').textContent = data.capturedWhite || 0;
            }
            
            // 게임 모드에 따른 특수 버튼 업데이트 (게임 모드 정보가 있으면)
            if (data.game && data.game.mode) {
                updateSpecialButtons(data.game.mode);
            }
            
            // 나가기 버튼 업데이트
            updateLeaveButton();
        });
        
        // 아바타 업데이트 이벤트
        socket.on('avatar_updated', (data) => {
            if (data.userId && data.avatar) {
                updateAvatar(data.userId, data.avatar);
            }
        });

        socket.on('move_made', (data) => {
            window.game.makeMove(data.move);
            // 내 턴인지 업데이트
            const isMyTurn = (data.move.color === 'black' && window.game.currentColor === 'white' && data.game && data.game.whiteId === currentUser.id) ||
                            (data.move.color === 'white' && window.game.currentColor === 'black' && data.game && data.game.blackId === currentUser.id);
            window.game.isMyTurn = isMyTurn;
            updateTurnIndicator(data.move.moveNumber || window.game.moveNumber, data.move.color === 'black' ? 'white' : 'black');
            
            // 통과 여부 확인
            if (data.move.isPass) {
                const passColor = data.move.color === 'black' ? '흑' : '백';
                updateGameNotice(`${passColor}이(가) 통과했습니다.`);
            } else {
                const nextColor = data.move.color === 'black' ? '백' : '흑';
                const myTurnText = isMyTurn ? ' (내 차례)' : ' (상대 차례)';
                updateGameNotice(`${nextColor}의 차례입니다.${myTurnText}`);
            }
            
            addChatMessage(data.move.color === 'black' ? '흑' : '백', data.move.isPass ? '통과' : `${String.fromCharCode(65 + data.move.x)}${data.move.y + 1}`);
        });

        socket.on('ai_move', (data) => {
            document.getElementById('aiThinking').classList.remove('active');
            window.game.makeMove(data.move);
            
            // AI 이동 후 내 턴인지 업데이트
            const nextColor = data.move.color === 'black' ? 'white' : 'black';
            let isMyTurn = false;
            
            if (data.game && data.game.isAiGame) {
                const aiColor = data.game.aiColor || 'white';
                if (nextColor === 'black' && aiColor !== 'black' && data.game.blackId === currentUser.id) {
                    isMyTurn = true;
                } else if (nextColor === 'white' && aiColor !== 'white' && data.game.whiteId === currentUser.id) {
                    isMyTurn = true;
                }
            }
            
            window.game.isMyTurn = isMyTurn;
            
            // AI 통과 확인
            if (data.move.isPass) {
                updateGameNotice('AI가 통과했습니다.');
            } else {
                const turnText = nextColor === 'black' ? '흑' : '백';
                const myTurnText = isMyTurn ? ' (내 차례)' : ' (AI 차례)';
                updateGameNotice(`${turnText}의 차례입니다.${myTurnText}`);
            }
            
            updateTurnIndicator(data.move.moveNumber || window.game.moveNumber, nextColor);
            addChatMessage('AI', data.move.isPass ? '통과' : `${String.fromCharCode(65 + data.move.x)}${data.move.y + 1}`);
        });

        socket.on('ai_thinking', () => {
            document.getElementById('aiThinking').classList.add('active');
        });

        socket.on('ai_error', (data) => {
            document.getElementById('aiThinking').classList.remove('active');
            alert(`AI 오류: ${data.error || '알 수 없는 오류가 발생했습니다.'}`);
        });

        socket.on('timer_update', (data) => {
            window.timer.updateTimers(data);
            if (data.blackTime !== undefined) {
                updateTimerBar('black', data.blackTime, 30 * 60);
            }
            if (data.whiteTime !== undefined) {
                updateTimerBar('white', data.whiteTime, 30 * 60);
            }
        });

        socket.on('timer_expired', (data) => {
            alert(`${data.color === 'black' ? '흑' : '백'}의 시간이 초과되었습니다.`);
        });

        socket.on('game_ended', (data) => {
            gameEnded = true;
            document.getElementById('gameStatus').textContent = `대국 종료`;
            updateGameNotice('대국이 종료되었습니다.');
            updateLeaveButton();
            
            // Extract current user rewards
            const isBlack = currentUser.id === window.game.blackId;
            const myRewards = isBlack ? data.rewards?.black : data.rewards?.white;
            
            showResultModal({
                ...data,
                rewards: myRewards
            });
        });

        function showResultModal(data) {
            const isWinner = (data.result === 'black_win' && currentUser.id === window.game.blackId) || 
                             (data.result === 'white_win' && currentUser.id === window.game.whiteId);
            const isDraw = data.result === 'draw';
            
            let resultTitle = isWinner ? '승리!' : '패배';
            if (isDraw) resultTitle = '무승부';
            
            const titleClass = isWinner ? 'win-text' : (isDraw ? 'draw-text' : 'lose-text');
            const winnerText = data.result === 'black_win' ? '흑 승리' : (data.result === 'white_win' ? '백 승리' : '무승부');

            const modalHtml = `
                <div class="result-modal-content">
                    <div class="result-header">
                        <div class="result-title ${titleClass}">${resultTitle}</div>
                        <div class="result-winner">${winnerText}</div>
                    </div>
                    <div class="result-body">
                        <div class="result-stats-grid">
                            <div class="result-stat-item">
                                <div class="stat-label">흑 점수</div>
                                <div class="stat-value">${data.score?.blackScore || 0}</div>
                            </div>
                            <div class="result-stat-item">
                                <div class="stat-label">백 점수 (덤 포함)</div>
                                <div class="stat-value">${data.score?.whiteScore || 6.5}</div>
                            </div>
                        </div>
                        
                        <div class="reward-section">
                            <div class="reward-item">
                                <div class="reward-icon">💰</div>
                                <div class="reward-label">골드 획득</div>
                                <div class="reward-value">+${data.rewards?.gold || 0}</div>
                            </div>
                            <div class="reward-item">
                                <div class="reward-icon">⭐</div>
                                <div class="reward-label">레이팅 변화</div>
                                <div class="reward-value">${data.rewards?.ratingChange >= 0 ? '+' : ''}${data.rewards?.ratingChange || 0}</div>
                            </div>
                        </div>
                    </div>
                    <div class="result-actions">
                        <button class="btn btn-home" onclick="window.location.href='/waiting-room'">나가기</button>
                        <button class="btn btn-retry" onclick="window.location.reload()">다시하기</button>
                    </div>
                </div>
            `;

            Modal.open('gameResult', modalHtml);
        }

        socket.on('score_result', (data) => {
            Modal.open('scoreResult', `
                <h2>계가 결과</h2>
                <p>흑: ${data.blackScore}점</p>
                <p>백: ${data.whiteScore}점</p>
                <p>승자: ${data.winner === 'black' ? '흑' : '백'}</p>
            `);
        });

        // 채팅 기능
        let activeChatTab = 'game';
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');

        document.querySelectorAll('.chat-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeChatTab = tab.dataset.tab;
            });
        });

        function addChatMessage(username, message, isSystem = false) {
            const messageDiv = document.createElement('div');
            if (isSystem) {
                messageDiv.className = 'chat-message chat-message-system';
                messageDiv.textContent = message;
            } else {
                messageDiv.className = 'chat-message chat-message-user';
                messageDiv.innerHTML = `<span class="username">${escapeHtml(username)}:</span> ${escapeHtml(message)}`;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            if (activeChatTab === 'game') {
                // 대국실 채팅 - 게임 룸 내에서만
                socket.emit('game_chat_message', { message: message });
            } else {
                // 전체채팅 - 대기실 채팅과 동일
                socket.emit('chat_message', {
                    user: currentUser.nickname,
                    message: message,
                    timestamp: Date.now()
                });
            }
            chatInput.value = '';
        }

        chatSendBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // 대국실 채팅 메시지 수신
        socket.on('game_chat_message', (data) => {
            if (data && data.user && data.message) {
                // 대국실 탭일 때만 표시
                if (activeChatTab === 'game') {
                    addChatMessage(data.user, data.message);
                }
            }
        });

        // 전체채팅 메시지 수신 (대기실과 동일)
        socket.on('chat_message', (data) => {
            if (activeChatTab === 'global' && data && data.user && data.message) {
                addChatMessage(data.user, data.message);
            }
        });

        socket.on('chat_error', (data) => {
            if (data && data.error) {
                alert('채팅 오류: ' + data.error);
            }
        });

        // 이모지 버튼 클릭 핸들러
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPopup = document.getElementById('emojiPopup');

        if (emojiBtn && emojiPopup) {
            function updatePopupPosition() {
                if (emojiPopup.classList.contains('show') || emojiPopup.style.display === 'flex') {
                    const btnRect = emojiBtn.getBoundingClientRect();
                    const popupHeight = 280;
                    const popupWidth = 350;
                    
                    // 버튼 위에 팝업 배치 (버튼의 top 위치에서 팝업 높이 + 간격만큼 위로)
                    emojiPopup.style.position = 'fixed';
                    emojiPopup.style.bottom = `${window.innerHeight - btnRect.top + 10}px`;
                    emojiPopup.style.left = `${btnRect.left}px`;
                    
                    // 화면 오른쪽으로 넘어가지 않도록 조정
                    if (btnRect.left + popupWidth > window.innerWidth) {
                        emojiPopup.style.left = `${window.innerWidth - popupWidth - 10}px`;
                    }
                    
                    // 화면 왼쪽으로 넘어가지 않도록 조정
                    if (btnRect.left < 0) {
                        emojiPopup.style.left = '10px';
                    }
                }
            }

            emojiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                if (emojiPopup.classList.contains('show')) {
                    // 닫기 애니메이션
                    emojiPopup.classList.remove('show');
                    setTimeout(() => {
                        emojiPopup.style.display = 'none';
                    }, 300);
                } else {
                    // 열기 애니메이션
                    emojiPopup.style.display = 'flex';
                    updatePopupPosition();
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            emojiPopup.classList.add('show');
                            updatePopupPosition();
                        });
                    });
                }
            });

            // 창 크기 변경 시 위치 업데이트
            let popupResizeTimeout;
            window.addEventListener('resize', () => {
                if (emojiPopup.classList.contains('show')) {
                    clearTimeout(popupResizeTimeout);
                    popupResizeTimeout = setTimeout(() => {
                        updatePopupPosition();
                    }, 50);
                }
            });

            // 스크롤 시 위치 업데이트
            let popupScrollTimeout;
            window.addEventListener('scroll', () => {
                if (emojiPopup.classList.contains('show')) {
                    clearTimeout(popupScrollTimeout);
                    popupScrollTimeout = setTimeout(() => {
                        updatePopupPosition();
                    }, 10);
                }
            }, true);

            // 주기적으로 위치 업데이트
            let positionUpdateInterval;
            function startPositionUpdate() {
                if (positionUpdateInterval) {
                    clearInterval(positionUpdateInterval);
                }
                positionUpdateInterval = setInterval(() => {
                    if (emojiPopup.classList.contains('show')) {
                        updatePopupPosition();
                    } else {
                        clearInterval(positionUpdateInterval);
                        positionUpdateInterval = null;
                    }
                }, 100);
            }

            // 팝업이 열릴 때 위치 업데이트 시작
            const originalAddClass = emojiPopup.classList.add.bind(emojiPopup.classList);
            emojiPopup.classList.add = function(...args) {
                originalAddClass(...args);
                if (args.includes('show')) {
                    startPositionUpdate();
                }
            };

            // 팝업이 닫힐 때 위치 업데이트 중지
            const originalRemoveClass = emojiPopup.classList.remove.bind(emojiPopup.classList);
            emojiPopup.classList.remove = function(...args) {
                originalRemoveClass(...args);
                if (args.includes('show') && positionUpdateInterval) {
                    clearInterval(positionUpdateInterval);
                    positionUpdateInterval = null;
                }
            };

            // 팝업 외부 클릭 시 닫기
            document.addEventListener('click', (e) => {
                if (emojiPopup && !emojiPopup.contains(e.target) && e.target !== emojiBtn && !emojiBtn.contains(e.target)) {
                    if (emojiPopup.classList.contains('show')) {
                        emojiPopup.classList.remove('show');
                        setTimeout(() => {
                            emojiPopup.style.display = 'none';
                        }, 300);
                    }
                }
            });

            // 탭 전환
            const emojiTabs = document.querySelectorAll('.emoji-tab');
            emojiTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const tabName = tab.getAttribute('data-tab');
                    
                    // 모든 탭 비활성화
                    emojiTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.emoji-section').forEach(s => s.classList.remove('active'));
                    
                    // 선택한 탭 활성화
                    tab.classList.add('active');
                    if (tabName === 'emoji') {
                        const emojiSection = document.getElementById('emojiSection');
                        if (emojiSection) emojiSection.classList.add('active');
                    } else if (tabName === 'quick') {
                        const quickSection = document.getElementById('quickSection');
                        if (quickSection) quickSection.classList.add('active');
                    }
                });
            });

            // 이모지 클릭 (이벤트 위임 사용)
            emojiPopup.addEventListener('click', (e) => {
                const emojiItem = e.target.closest('.emoji-item');
                if (emojiItem) {
                    e.stopPropagation();
                    if (chatInput.disabled) return;
                    const emoji = emojiItem.textContent.trim();
                    chatInput.value += emoji;
                    chatInput.focus();
                    emojiPopup.classList.remove('show');
                    setTimeout(() => {
                        emojiPopup.style.display = 'none';
                    }, 300);
                }

                // 퀵 메시지 클릭
                const quickBtn = e.target.closest('.quick-message-btn');
                if (quickBtn) {
                    e.stopPropagation();
                    if (chatInput.disabled) return;
                    const message = quickBtn.textContent;
                    chatInput.value = message;
                    chatInput.focus();
                    emojiPopup.classList.remove('show');
                    setTimeout(() => {
                        emojiPopup.style.display = 'none';
                    }, 300);
                }
            });
        }

        // Button handlers
        document.getElementById('passBtn').addEventListener('click', () => {
            socket.emit('make_move', { move: { isPass: true } });
        });

        document.getElementById('resignBtn').addEventListener('click', () => {
            if (confirm('정말 기권하시겠습니까?')) {
                updateGameNotice('기권했습니다. 게임이 곧 종료됩니다.');
                socket.emit('resign');
            }
        });

        // 나가기 버튼
        document.getElementById('leaveBtn').addEventListener('click', () => {
            if (gameEnded) {
                window.location.href = '/waiting-room';
            }
        });

        // 일시정지 버튼
        document.getElementById('pauseBtn').addEventListener('click', () => {
            if (!isPaused) {
                socket.emit('pause_game', { gameId });
                document.getElementById('pauseBtn').textContent = '재개';
                isPaused = true;
            } else {
                socket.emit('resume_game', { gameId });
                document.getElementById('pauseBtn').textContent = '일시정지';
                isPaused = false;
            }
        });

        socket.on('game_paused', () => {
            isPaused = true;
            document.getElementById('pauseBtn').textContent = '재개';
        });

        socket.on('game_resumed', () => {
            isPaused = false;
            document.getElementById('pauseBtn').textContent = '일시정지';
        });

        // 설정 버튼 클릭 이벤트
        document.getElementById('settingsBtn').addEventListener('click', () => {
            // 설정 모달 열기 (나중에 구현)
            alert('설정 기능은 준비 중입니다.');
        });

        // 시간 포맷팅 함수 (밀리초를 MM:SS 형식으로)
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }


        // 초기 설정
        updateSpecialButtons('standard'); // 기본 모드로 시작, 게임 상태 받으면 업데이트
        updateLeaveButton();

        // Request initial game state
        socket.emit('get_game_state');
    </script>
</body>
</html>
