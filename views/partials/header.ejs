<header class="main-header">
    <div class="header-left">
        <a href="/waiting-room" class="logo-link">
            <h1 class="logo">SUDAM</h1>
        </a>
        <div class="user-profile-section">
            <div class="user-avatar-small">
                <%= user ? user.nickname.charAt(0).toUpperCase() : 'U' %>
            </div>
            <div class="user-name-small">
                <%= user ? user.nickname : 'Guest' %>
            </div>
        </div>
    </div>
    <div class="header-center">
        <div class="currency-section">
            <img src="/images/Gold.webp" alt="ê¸ˆí™”" class="currency-icon" onerror="this.style.display='none';">
            <span class="currency-amount">0</span>
        </div>
        <div class="ticket-section">
            <div class="ticket-item ticket-strategy" id="strategyTicketItem">
                <div class="ticket-icon ticket-yellow">ğŸ«</div>
                <div class="ticket-info">
                    <span class="ticket-count" id="strategyTicketCount">0/10</span>
                    <span class="ticket-timer" id="strategyTicketTimer" style="display: none;"></span>
                </div>
            </div>
            <div class="ticket-item ticket-casual" id="casualTicketItem">
                <div class="ticket-icon ticket-blue">ğŸ«</div>
                <div class="ticket-info">
                    <span class="ticket-count" id="casualTicketCount">0/10</span>
                    <span class="ticket-timer" id="casualTicketTimer" style="display: none;"></span>
                </div>
            </div>
        </div>
    </div>
    <div class="header-right">
        <button class="header-btn shop-btn" title="ìƒì ">
            <img src="/images/store.webp" alt="ìƒì " class="header-icon" onerror="this.style.display='none';">
        </button>
        <button class="header-btn mailbox-btn" title="ìš°í¸í•¨">
            <img src="/images/mail.webp" alt="ìš°í¸í•¨" class="header-icon" onerror="this.style.display='none';">
        </button>
        <button class="header-btn notice-btn" id="noticeBtn" title="ê³µì§€ì‚¬í•­">ğŸ“¢</button>
        <button class="header-btn settings-btn" title="ì„¤ì •">âš™ï¸</button>
        <button class="header-btn logout-btn" id="logoutBtn" title="ë¡œê·¸ì•„ì›ƒ">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<style>
    .main-header {
        background: #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 12px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .logo-link {
        text-decoration: none;
        color: #333;
    }

    .logo {
        margin: 0;
        font-size: 24px;
        color: #667eea;
        font-weight: 700;
    }

    .user-profile-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-avatar-small {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
        flex-shrink: 0;
    }

    .user-name-small {
        font-weight: 600;
        color: #333;
        font-size: 15px;
    }

    .header-center {
        display: flex;
        align-items: center;
        gap: 20px;
        flex: 1;
        justify-content: center;
    }

    .currency-section {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .currency-icon, .header-icon {
        width: 24px;
        height: 24px;
        object-fit: contain;
        display: inline-block;
    }
    
    .currency-icon[style*="display: none"],
    .header-icon[style*="display: none"] {
        display: none !important;
    }

    .currency-icon-fallback, .header-icon-fallback {
        font-size: 20px;
        display: none;
    }
    
    .currency-icon-fallback[style*="display: inline-block"],
    .header-icon-fallback[style*="display: inline-block"] {
        display: inline-block !important;
    }

    .currency-amount {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }

    .ticket-section {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .ticket-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 2px solid;
        transition: all 0.3s;
    }

    .ticket-strategy {
        border-color: #fbbf24;
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    }

    .ticket-casual {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
    }

    .ticket-icon {
        font-size: 20px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ticket-yellow {
        filter: hue-rotate(0deg) saturate(1.5) brightness(1.1);
    }

    .ticket-blue {
        filter: hue-rotate(200deg) saturate(1.3) brightness(1.1);
    }

    .ticket-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .ticket-count {
        font-weight: 600;
        font-size: 14px;
        line-height: 1.2;
    }

    .ticket-strategy .ticket-count {
        color: #fef3c7;
    }

    .ticket-casual .ticket-count {
        color: #dbeafe;
    }

    .ticket-timer {
        font-size: 11px;
        color: #666;
        font-weight: 500;
    }

    .ticket-strategy .ticket-timer {
        color: #fde68a;
    }

    .ticket-casual .ticket-timer {
        color: #bfdbfe;
    }

    .notice-btn {
        padding: 8px 12px;
        font-size: 18px;
        width: auto;
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .header-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        background: #f5f5f5;
        color: #333;
        min-height: 40px;
        box-sizing: border-box;
    }

    .header-btn:hover {
        background: #e0e0e0;
        transform: translateY(-1px);
    }

    .shop-btn, .mailbox-btn {
        padding: 8px 12px;
    }

    .settings-btn {
        padding: 8px 12px;
        font-size: 18px;
    }

    .logout-btn {
        background: #ef4444;
        color: white;
        font-weight: 600;
    }

    .logout-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }
</style>

<script>
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
            const response = await fetch('/api/auth/logout', {
                method: 'POST',
            });
            const data = await response.json();
            if (data.success) {
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('Logout error:', error);
        }
    });

    // ê³µì§€ì‚¬í•­ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
    document.getElementById('noticeBtn')?.addEventListener('click', () => {
        alert('ê³µì§€ì‚¬í•­ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        // TODO: ê³µì§€ì‚¬í•­ ëª¨ë‹¬ ë˜ëŠ” í˜ì´ì§€ êµ¬í˜„
    });

    // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (ë°€ë¦¬ì´ˆë¥¼ MM:SS í˜•ì‹ìœ¼ë¡œ)
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // ì´ìš©ê¶Œ ê°œìˆ˜ ë° íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateTicketCounts() {
        try {
            const response = await fetch('/api/ticket/tickets');
            const data = await response.json();
            console.log('Ticket API response:', data);
            if (data.success && data.tickets) {
                const strategyCountEl = document.getElementById('strategyTicketCount');
                const casualCountEl = document.getElementById('casualTicketCount');
                const strategyTimerEl = document.getElementById('strategyTicketTimer');
                const casualTimerEl = document.getElementById('casualTicketTimer');
                
                // ì „ëµë°”ë‘‘ ì´ìš©ê¶Œ - "ë‚¨ì€ê°œìˆ˜/ìµœëŒ€ì¹˜" í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
                if (strategyCountEl) {
                    const strategyTickets = data.tickets.strategyTickets ?? 0;
                    const strategyMax = data.tickets.strategyMax ?? 10;
                    strategyCountEl.textContent = `${strategyTickets}/${strategyMax}`;
                    console.log('Updated strategy tickets:', `${strategyTickets}/${strategyMax}`);
                }
                
                // ì „ëµë°”ë‘‘ íƒ€ì´ë¨¸ í‘œì‹œ
                if (strategyTimerEl) {
                    if (data.tickets.strategyTickets < data.tickets.strategyMax) {
                        const timeResponse = await fetch('/api/ticket/recovery-time?ticketType=strategy');
                        const timeData = await timeResponse.json();
                        if (timeData.success) {
                            strategyTimerEl.textContent = formatTime(timeData.timeRemaining);
                            strategyTimerEl.style.display = 'block';
                        }
                    } else {
                        strategyTimerEl.style.display = 'none';
                    }
                }
                
                // ë†€ì´ë°”ë‘‘ ì´ìš©ê¶Œ - "ë‚¨ì€ê°œìˆ˜/ìµœëŒ€ì¹˜" í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
                if (casualCountEl) {
                    const casualTickets = data.tickets.casualTickets ?? 0;
                    const casualMax = data.tickets.casualMax ?? 10;
                    casualCountEl.textContent = `${casualTickets}/${casualMax}`;
                    console.log('Updated casual tickets:', `${casualTickets}/${casualMax}`);
                }
                
                // ë†€ì´ë°”ë‘‘ íƒ€ì´ë¨¸ í‘œì‹œ
                if (casualTimerEl) {
                    if (data.tickets.casualTickets < data.tickets.casualMax) {
                        const timeResponse = await fetch('/api/ticket/recovery-time?ticketType=casual');
                        const timeData = await timeResponse.json();
                        if (timeData.success) {
                            casualTimerEl.textContent = formatTime(timeData.timeRemaining);
                            casualTimerEl.style.display = 'block';
                        }
                    } else {
                        casualTimerEl.style.display = 'none';
                    }
                }
            }
        } catch (error) {
            console.error('Update ticket counts error:', error);
        }
    }

    // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (1ì´ˆë§ˆë‹¤)
    function updateTicketTimers() {
        const strategyTimerEl = document.getElementById('strategyTicketTimer');
        const casualTimerEl = document.getElementById('casualTicketTimer');
        
        if (strategyTimerEl && strategyTimerEl.style.display !== 'none') {
            fetch('/api/ticket/recovery-time?ticketType=strategy')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        strategyTimerEl.textContent = formatTime(data.timeRemaining);
                        if (data.timeRemaining <= 0) {
                            updateTicketCounts(); // íšŒë³µ ì‹œê°„ì´ ì§€ë‚˜ë©´ ì „ì²´ ì—…ë°ì´íŠ¸
                        }
                    }
                })
                .catch(err => console.error('Timer update error:', err));
        }
        
        if (casualTimerEl && casualTimerEl.style.display !== 'none') {
            fetch('/api/ticket/recovery-time?ticketType=casual')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        casualTimerEl.textContent = formatTime(data.timeRemaining);
                        if (data.timeRemaining <= 0) {
                            updateTicketCounts(); // íšŒë³µ ì‹œê°„ì´ ì§€ë‚˜ë©´ ì „ì²´ ì—…ë°ì´íŠ¸
                        }
                    }
                })
                .catch(err => console.error('Timer update error:', err));
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ìš©ê¶Œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            updateTicketCounts();
            // 1ì´ˆë§ˆë‹¤ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
            setInterval(updateTicketTimers, 1000);
            // 30ì´ˆë§ˆë‹¤ ì´ìš©ê¶Œ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (íšŒë³µ í™•ì¸)
            setInterval(updateTicketCounts, 30000);
        });
    } else {
        updateTicketCounts();
        setInterval(updateTicketTimers, 1000);
        setInterval(updateTicketCounts, 30000);
    }
</script>
