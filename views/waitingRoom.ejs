<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUDAM - 대기실</title>
    <link rel="stylesheet" href="/css/modal.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            <% if (typeof roomType !== 'undefined' && roomType === 'casual') { %>
            background: linear-gradient(135deg, #9ae6b4 0%, #7dd3a0 100%);
            <% } else { %>
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            <% } %>
            min-height: 100vh;
            padding-bottom: 0;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .container {
            width: 1600px;
            margin: 0 auto;
            padding: 20px 20px 0 20px;
            box-sizing: border-box;
            transform-origin: top center;
            position: relative;
        }

        .notice-board {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .waiting-room-grid {
            display: grid;
            grid-template-columns: minmax(280px, 350px) 1.7fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 0;
            height: calc(100vh - 180px);
            min-height: 600px;
            max-height: calc(100vh - 180px);
            width: 100%;
            max-width: 1560px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
            align-items: stretch;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-width: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .panel-title-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title-text::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            border-radius: 2px;
        }

        .panel-title-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transform-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            border: 2px solid #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .transform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .transform-btn:active {
            transform: translateY(0);
        }

        .ai-battle-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
            border: 2px solid #f5576c;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-battle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }

        .ai-battle-btn:active {
            transform: translateY(0);
        }

        .ongoing-games {
            grid-column: 2;
            grid-row: 1 / 3;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .room-number-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .room-number-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            border-color: #667eea;
            transition: border-color 0.3s;
        }
        
        .room-number-input:focus {
            outline: none;
            border-color: #5568d3;
        }
        
        .watch-by-room-btn {
            background: #667eea;
            border: 2px solid #5568d3;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .watch-by-room-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        #ongoingGamesList {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }

        .game-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .game-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .game-room-number-badge {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .game-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 140px;
            flex-shrink: 0;
        }

        .game-title {
            font-size: 13px;
            color: #334155;
            font-weight: 600;
            line-height: 1.3;
        }

        .game-players {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            justify-content: center;
            min-width: 0;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-stone {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .player-stone.black {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            border-color: #000;
        }

        .player-stone.white {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            color: #1a1a1a;
            border-color: #d1d5db;
        }

        .player-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .player-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
            white-space: nowrap;
        }

        .player-rating {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .vs-divider {
            color: #94a3b8;
            font-weight: 700;
            font-size: 13px;
            padding: 0 8px;
        }

        .watch-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
        }

        .watch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }


        .online-users {
            grid-column: 3;
            grid-row: 1 / 4;
            overflow-y: auto;
            height: 100%;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        #onlineUsersList {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        .user-item:hover { background: #f5f5f5; }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-nickname {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .user-rating {
            font-size: 12px;
            color: #666;
        }

        .user-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-waiting { background: #e3f2fd; color: #1976d2; }
        .status-matching { background: #fff3e0; color: #f57c00; }
        .status-in-game { background: #e8f5e9; color: #388e3c; }
        .status-resting { background: #f3e5f5; color: #7b1fa2; }
        .status-spectating { background: #fff9c4; color: #f57f17; }

        .current-user-item {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-board {
            grid-column: 1;
            grid-row: 2 / 4;
            overflow-y: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #rankingList {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .chat-panel {
            grid-column: 2;
            grid-row: 3;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 350px;
            max-height: 100%;
            flex: 0 0 auto;
            position: relative;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            min-height: 0;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
            margin-top: auto;
            position: relative;
            z-index: 10;
        }

        .emoji-btn-wrapper {
            position: relative;
        }

        .emoji-btn {
            width: 48px;
            height: 48px;
            padding: 0;
            background: #667eea;
            border: 2px solid #5568d3;
            color: white;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .chat-input {
            width: 100%;
            height: 48px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .chat-send-btn {
            width: 48px;
            height: 48px;
            padding: 0;
            background: #667eea;
            color: white;
            border: 2px solid #5568d3;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .emoji-popup {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 350px;
            max-height: 0;
            height: 280px;
            z-index: 10001;
            overflow: hidden;
            display: none;
            flex-direction: column;
            border: 1px solid #e0e0e0;
            box-sizing: border-box;
            opacity: 0;
            bottom: 100%;
            left: 0;
            margin-bottom: 10px;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease, max-height 0.3s ease;
        }

        .emoji-popup.show {
            display: flex;
            max-height: 280px;
            opacity: 1;
            transform: translateY(0);
        }

        .stats-modal {
            display: none;
            position: fixed;
            z-index: 100000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow: auto;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .stats-modal.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .stats-modal-content {
            background-color: white;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: default;
        }

        /* 프로필 패널 스타일 */
        .profile-panel {
            grid-column: 1;
            grid-row: 1;
            display: flex;
            flex-direction: column;
        }

        .profile-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .profile-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 700;
            margin: 0 auto 15px;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .profile-stats-with-detail {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-stats-compact {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .profile-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .profile-stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .detail-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .detail-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .matching-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .matching-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .matching-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .matching-rating {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .matching-status {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }

        .matching-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .matching-buttons .btn {
            width: 100%;
        }

        /* 랭킹 아이템 스타일 */
        .my-ranking-item {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .my-ranking-item .rank-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid #667eea;
        }

        .my-ranking-item .ranking-nickname {
            color: #667eea;
            font-weight: 700;
        }

        .my-ranking-item .ranking-rating {
            color: #667eea;
            font-weight: 700;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        .ranking-item:hover {
            background: #f5f5f5;
        }

        .rank-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .ranking-user-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-nickname {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .ranking-stats {
            font-size: 12px;
            color: #666;
        }

        .ranking-rating {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
            flex-shrink: 0;
        }

        /* 빈 상태 스타일 */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }

        /* 채팅 메시지 스타일 */
        .chat-message {
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 8px;
            background: white;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .message-user {
            font-weight: 600;
            color: #667eea;
            font-size: 13px;
        }

        .message-content {
            color: #333;
            font-size: 14px;
            flex: 1;
        }

        .message-time {
            color: #999;
            font-size: 11px;
        }

        /* 이모지 팝업 스타일 */
        .emoji-popup-header {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            padding: 0;
            background: #f9f9f9;
        }

        .emoji-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.2s;
        }

        .emoji-tab:hover {
            background: #f0f0f0;
        }

        .emoji-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .emoji-popup-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .emoji-section {
            display: none;
        }

        .emoji-section.active {
            display: block;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .emoji-item {
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            text-align: center;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .emoji-item:hover {
            background: #f0f0f0;
        }

        .quick-message-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-message-btn {
            padding: 12px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-align: left;
            transition: all 0.2s;
        }

        .quick-message-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chat-input-wrapper {
            position: relative;
            flex: 1;
        }

        .chat-countdown {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }


        /* 유저 정보 스타일 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .status-dropdown {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .status-dropdown:hover {
            border-color: #667eea;
        }

        .status-dropdown:focus {
            outline: none;
            border-color: #667eea;
        }

        /* 대국 신청/AI 설정 통합 모달 스타일 */
        .request-modal-content {
            width: 900px;
            max-width: 95vw;
            padding: 0;
            overflow: hidden;
            border-radius: 16px;
        }

        .request-modal-body {
            display: flex;
            min-height: 600px;
            max-height: 80vh;
        }

        .request-sidebar {
            width: 240px;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: 2px solid #e2e8f0;
            padding: 25px 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .request-right-panel {
            width: 280px;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-left: 2px solid #e2e8f0;
            padding: 25px 20px;
            overflow-y: auto;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .request-category-title {
            font-size: 14px;
            color: #475569;
            margin-bottom: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 12px;
            border-bottom: 2px solid #cbd5e1;
        }

        .request-mode-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .request-mode-item {
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            color: #475569;
            background: white;
            border: 2px solid transparent;
            text-align: left;
            width: 100%;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .request-mode-item:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateX(4px);
        }

        .request-mode-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            border-color: transparent;
            transform: translateX(4px);
        }

        .request-main {
            flex: 1;
            padding: 35px 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 28px;
            background: white;
        }

        .target-user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 25px;
            border-radius: 14px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-avatar-small {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 32px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
        }

        .target-user-details {
            text-align: center;
            width: 100%;
        }

        .target-nickname {
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .target-rating {
            font-size: 18px;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .target-game-stats {
            width: 100%;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .target-game-stats-title {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 12px;
            text-align: center;
        }

        .target-game-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .target-stat-item {
            text-align: center;
            padding: 12px 8px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .target-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .target-stat-label {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }

        .request-section {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .form-select, .form-textarea {
            width: 100%;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            color: #1e293b;
            padding: 14px 18px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .form-select:focus, .form-textarea:focus {
            border-color: #667eea;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            height: 120px;
            resize: none;
            font-family: inherit;
        }

        .ai-battle-label {
            font-size: 17px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .ai-level-buttons, .ai-color-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .ai-level-btn, .ai-color-btn {
            padding: 14px 16px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #475569;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .ai-level-btn:hover, .ai-color-btn:hover {
            border-color: #667eea;
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .ai-level-btn.active, .ai-color-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .ai-battle-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 25px;
            border-top: 2px solid #e2e8f0;
        }

        .ai-battle-actions .btn {
            min-width: 140px;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 12px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .stats-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .stats-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #333;
        }

        .stats-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .stats-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .stats-tab:hover {
            color: #667eea;
            background: #f9f9f9;
        }

        .stats-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .stats-tab-content {
            display: none;
        }

        .stats-tab-content.active {
            display: block;
        }

        .stats-summary {
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stats-item {
            text-align: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .stats-item-value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .stats-item-label {
            font-size: 12px;
            color: #666;
        }

        .game-types-list {
            margin-top: 15px;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
        }

        .game-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .game-type-item:hover {
            background: #f0f0f0;
        }

        .game-type-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .game-type-stats {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .stats-modal-options {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .stats-modal-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }

        .game-response-body {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
            text-align: center;
        }

        .request-sender-info {
            display: flex;
            align-items: center;
            gap: 20px;
            background: #f8fafc;
            padding: 20px;
            border-radius: 15px;
            width: 100%;
        }

        .sender-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .sender-nickname {
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
        }

        .sender-mode {
            font-size: 15px;
            color: #667eea;
            font-weight: 700;
            margin-top: 4px;
        }

        .sender-message {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 12px;
            font-style: italic;
            color: #475569;
            width: 100%;
            border-left: 4px solid #667eea;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <%- include('partials/header', { user: user }) %>

    <!-- 통계 모달 -->
    <div id="statsModal" class="stats-modal">
        <div class="stats-modal-content">
            <div class="stats-modal-header" id="statsModalHeader">
                <div class="stats-modal-title">전적 상세보기</div>
                <button class="close-modal" id="closeStatsModalBtn">&times;</button>
            </div>
            <div class="stats-tabs">
                <button class="stats-tab active" onclick="switchStatsTab('strategy')">전략바둑</button>
                <button class="stats-tab" onclick="switchStatsTab('casual')">놀이바둑</button>
            </div>
            <div id="strategyTab" class="stats-tab-content active">
                <div class="stats-summary">
                    <div class="stats-grid">
                        <div class="stats-item">
                            <div class="stats-item-value" id="strategyWins">0</div>
                            <div class="stats-item-label">승</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-item-value" id="strategyLosses">0</div>
                            <div class="stats-item-label">패</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-item-value" id="strategyWinRate">0%</div>
                            <div class="stats-item-label">승률</div>
                        </div>
                    </div>
                </div>
                <div class="game-types-list">
                    <div class="game-type-item">
                        <div class="game-type-name">클래식바둑</div>
                        <div class="game-type-stats"><span id="strategyClassicWins">0승</span> / <span id="strategyClassicLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">따내기바둑</div>
                        <div class="game-type-stats"><span id="strategyCaptureWins">0승</span> / <span id="strategyCaptureLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">스피드바둑</div>
                        <div class="game-type-stats"><span id="strategySpeedWins">0승</span> / <span id="strategySpeedLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">베이스바둑</div>
                        <div class="game-type-stats"><span id="strategyBaseWins">0승</span> / <span id="strategyBaseLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">히든바둑</div>
                        <div class="game-type-stats"><span id="strategyHiddenWins">0승</span> / <span id="strategyHiddenLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">미사일바둑</div>
                        <div class="game-type-stats"><span id="strategyMissileWins">0승</span> / <span id="strategyMissileLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">믹스룰바둑</div>
                        <div class="game-type-stats"><span id="strategyMixWins">0승</span> / <span id="strategyMixLosses">0패</span></div>
                    </div>
                </div>
            </div>
            <div id="casualTab" class="stats-tab-content">
                <div class="stats-summary">
                    <div class="stats-grid">
                        <div class="stats-item">
                            <div class="stats-item-value" id="casualWins">0</div>
                            <div class="stats-item-label">승</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-item-value" id="casualLosses">0</div>
                            <div class="stats-item-label">패</div>
                        </div>
                        <div class="stats-item">
                            <div class="stats-item-value" id="casualWinRate">0%</div>
                            <div class="stats-item-label">승률</div>
                        </div>
                    </div>
                </div>
                <div class="game-types-list">
                    <div class="game-type-item">
                        <div class="game-type-name">주사위바둑</div>
                        <div class="game-type-stats"><span id="casualDiceWins">0승</span> / <span id="casualDiceLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">경찰과도둑</div>
                        <div class="game-type-stats"><span id="casualCopsWins">0승</span> / <span id="casualCopsLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">오목</div>
                        <div class="game-type-stats"><span id="casualOmokWins">0승</span> / <span id="casualOmokLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">따목</div>
                        <div class="game-type-stats"><span id="casualTtakWins">0승</span> / <span id="casualTtakLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">알까기</div>
                        <div class="game-type-stats"><span id="casualAlkkagiWins">0승</span> / <span id="casualAlkkagiLosses">0패</span></div>
                    </div>
                    <div class="game-type-item">
                        <div class="game-type-name">바둑컬링</div>
                        <div class="game-type-stats"><span id="casualCurlingWins">0승</span> / <span id="casualCurlingLosses">0패</span></div>
                    </div>
                </div>
            </div>
            <div class="stats-modal-options">
                <label><input type="checkbox" id="rememberPositionCheckbox"><span>창 위치 기억</span></label>
            </div>
        </div>
    </div>

    <!-- 대국 신청/AI 설정 통합 모달 -->
    <div id="gameRequestModal" class="stats-modal">
        <div class="stats-modal-content request-modal-content">
            <div class="stats-modal-header">
                <div class="stats-modal-title" id="requestModalTitle">대국 신청</div>
                <button class="close-modal" onclick="closeGameRequestModal()">&times;</button>
            </div>
            <div class="request-modal-body">
                <div class="request-sidebar">
                    <div class="request-category-title" id="requestCategoryTitle">전략바둑</div>
                    <div id="requestModeList" class="request-mode-list"></div>
                </div>
                <div class="request-main">
                    <div class="ai-only-section" id="aiLevelSection">
                        <label class="ai-battle-label">AI 난이도 선택</label>
                        <div class="ai-level-buttons">
                            <button class="ai-level-btn active" data-level="1">1단</button>
                            <button class="ai-level-btn" data-level="2">2단</button>
                            <button class="ai-level-btn" data-level="3">3단</button>
                            <button class="ai-level-btn" data-level="4">4단</button>
                            <button class="ai-level-btn" data-level="5">5단</button>
                            <button class="ai-level-btn" data-level="6">6단</button>
                            <button class="ai-level-btn" data-level="7">7단</button>
                            <button class="ai-level-btn" data-level="8">8단</button>
                            <button class="ai-level-btn" data-level="9">9단</button>
                        </div>
                    </div>
                    <div class="request-section">
                        <label class="ai-battle-label">내 색상 선택</label>
                        <div class="ai-color-buttons">
                            <button class="ai-color-btn active" data-color="black">흑 (선수)</button>
                            <button class="ai-color-btn" data-color="white">백 (후수)</button>
                            <button class="ai-color-btn" data-color="random">랜덤</button>
                        </div>
                    </div>
                    <div class="request-section" id="komiSection">
                        <label class="ai-battle-label">덤(Komi)</label>
                        <select id="komiSelect" class="form-select">
                            <option value="6.5">6.5집 (한국/일본식)</option>
                            <option value="7.5">7.5집 (중국식)</option>
                            <option value="0.5">0.5집 (호선)</option>
                        </select>
                    </div>
                    <div class="request-section mode-specific-settings" id="modeSpecificSettings" style="display: none;">
                        <!-- 게임 모드별 특정 설정이 여기에 동적으로 추가됩니다 -->
                    </div>
                    <div class="request-section pvp-only-section" id="messageSection">
                        <label class="ai-battle-label">대국 신청 메시지</label>
                        <textarea id="requestMessage" class="form-textarea" placeholder="상대방에게 보낼 메시지를 입력하세요..."></textarea>
                    </div>
                    <div class="ai-battle-actions">
                        <button class="btn btn-primary" id="confirmRequestBtn">신청하기</button>
                        <button class="btn btn-secondary" onclick="closeGameRequestModal()">취소</button>
                    </div>
                </div>
                <div class="request-right-panel" id="requestRightPanel" style="display: none;">
                    <div id="targetUserInfo" class="target-user-info">
                        <div class="user-avatar-small" id="targetUserAvatar">?</div>
                        <div class="target-user-details">
                            <div id="targetUserNickname" class="target-nickname">상대방</div>
                            <div id="targetUserRating" class="target-rating">레이팅: -</div>
                            <div class="target-game-stats">
                                <div class="target-game-stats-title" id="targetGameStatsTitle">클래식바둑 전적</div>
                                <div class="target-game-stats-grid">
                                    <div class="target-stat-item">
                                        <div class="target-stat-value" id="targetGameWins">0</div>
                                        <div class="target-stat-label">승</div>
                                    </div>
                                    <div class="target-stat-item">
                                        <div class="target-stat-value" id="targetGameLosses">0</div>
                                        <div class="target-stat-label">패</div>
                                    </div>
                                    <div class="target-stat-item">
                                        <div class="target-stat-value" id="targetGameWinRate">0%</div>
                                        <div class="target-stat-label">승률</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 대국 신청 수신 모달 -->
    <div id="gameResponseModal" class="stats-modal">
        <div class="stats-modal-content">
            <div class="stats-modal-header">
                <div class="stats-modal-title">대국 신청 도착</div>
            </div>
            <div class="game-response-body">
                <div class="request-sender-info">
                    <div class="user-avatar" id="senderAvatar">?</div>
                    <div class="sender-details">
                        <div id="senderNickname" class="sender-nickname">상대방</div>
                        <div id="senderMode" class="sender-mode">모드: 클래식</div>
                    </div>
                </div>
                <div id="senderMessage" class="sender-message">"대국 한 판 하실래요?"</div>
                <div class="ai-battle-actions">
                    <button class="btn btn-primary" id="acceptRequestBtn">수락</button>
                    <button class="btn btn-danger" id="rejectRequestBtn">거절</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 전광판 -->
        <div class="notice-board" id="noticeBoard">
            🎮 SUDAM 바둑 게임 플랫폼에 오신 것을 환영합니다! 즐거운 게임 되세요!
        </div>

        <!-- 메인 그리드 -->
        <div class="waiting-room-grid">
            <!-- 프로필 및 레이팅 매칭 -->
            <div class="panel profile-panel">
                <div class="profile-content">
                    <div class="profile-card">
                        <div class="profile-avatar-large"><%= user.nickname.charAt(0).toUpperCase() %></div>
                        <div class="profile-name"><%= user.nickname %></div>
                        <div class="profile-stats-with-detail">
                            <div class="profile-stats-compact">
                                <div class="profile-stat"><div class="profile-stat-value"><%= user.wins || 0 %></div><div class="profile-stat-label">승</div></div>
                                <div class="profile-stat"><div class="profile-stat-value"><%= user.losses || 0 %></div><div class="profile-stat-label">패</div></div>
                                <div class="profile-stat"><div class="profile-stat-value"><% const total = (user.wins || 0) + (user.losses || 0); const winRate = total > 0 ? Math.round((user.wins / total) * 100) : 0; %><%= winRate %>%</div><div class="profile-stat-label">승률</div></div>
                            </div>
                            <button class="detail-btn" id="detailBtn">상세보기</button>
                        </div>
                    </div>
                    <div class="matching-content" id="matchingContent">
                        <div class="matching-info">
                            <div class="matching-title">랭킹전 매칭</div>
                            <div class="matching-rating">레이팅: <%= user.rating %></div>
                            <div class="matching-status" id="matchingStatus">대기 중</div>
                        </div>
                        <div class="matching-buttons">
                            <button class="btn btn-primary" id="startMatchingBtn">매칭 시작</button>
                            <button class="btn btn-secondary" id="cancelMatchingBtn" style="display: none;">매칭 취소</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 대국중인 경기장 -->
            <div class="panel ongoing-games">
                <div class="panel-title">
                    <div class="panel-title-left">
                        <div class="panel-title-text"><%= (typeof roomType !== 'undefined' && roomType === 'casual') ? '놀이바둑 대기실' : '전략바둑 대기실' %></div>
                        <% if (typeof roomType === 'undefined' || roomType === 'strategy') { %>
                            <button class="transform-btn" onclick="window.location.href='/waiting-room-casual'">놀이바둑 대기실</button>
                        <% } else { %>
                            <button class="transform-btn" onclick="window.location.href='/waiting-room'">전략바둑 대기실</button>
                        <% } %>
                    </div>
                    <button class="ai-battle-btn" id="aiBattleBtn">AI봇 대결</button>
                </div>
                <div class="room-number-input-container">
                    <input type="text" id="roomNumberInput" placeholder="방번호 입력 (1-5)" class="room-number-input" maxlength="1">
                    <button id="watchByRoomNumberBtn" class="watch-by-room-btn">관전하기</button>
                </div>
                <div id="ongoingGamesList">
                    <div class="empty-state">진행 중인 게임이 없습니다.</div>
                </div>
            </div>

            <!-- 접속중인 유저 -->
            <div class="panel online-users">
                <div class="panel-title">접속중인 유저</div>
                <div id="onlineUsersList">
                    <div class="empty-state">접속 중인 유저가 없습니다.</div>
                </div>
            </div>

            <!-- 랭킹보드 -->
            <div class="panel ranking-board">
                <div class="panel-title">랭킹보드</div>
                <div id="rankingList">
                    <div class="empty-state">랭킹 데이터를 불러오는 중...</div>
                </div>
            </div>

            <!-- 채팅창 -->
            <div class="panel chat-panel">
                <div class="panel-title">채팅</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <button class="emoji-btn" id="emojiBtn">😊</button>
                    <div class="chat-input-wrapper">
                        <input type="text" class="chat-input" id="chatInput" placeholder="메시지를 입력하세요..." maxlength="200">
                        <div class="chat-countdown" id="chatCountdown" style="display: none;">3</div>
                    </div>
                    <button class="chat-send-btn" id="chatSendBtn">전송</button>
                    <div class="emoji-popup" id="emojiPopup">
                        <div class="emoji-popup-header">
                            <button class="emoji-tab active" data-tab="emoji">이모지</button>
                            <button class="emoji-tab" data-tab="quick">퀵 메시지</button>
                        </div>
                        <div class="emoji-popup-content">
                            <div class="emoji-section active" id="emojiSection">
                                <div class="emoji-grid">
                                    <span class="emoji-item">😊</span><span class="emoji-item">😄</span><span class="emoji-item">😁</span><span class="emoji-item">😆</span><span class="emoji-item">😅</span>
                                    <span class="emoji-item">🤣</span><span class="emoji-item">🙂</span><span class="emoji-item">🙃</span><span class="emoji-item">😉</span><span class="emoji-item">😌</span>
                                    <span class="emoji-item">😍</span><span class="emoji-item">🥰</span><span class="emoji-item">😘</span><span class="emoji-item">😗</span><span class="emoji-item">😙</span>
                                    <span class="emoji-item">😚</span><span class="emoji-item">😋</span><span class="emoji-item">😛</span><span class="emoji-item">😝</span><span class="emoji-item">😜</span>
                                    <span class="emoji-item">🤪</span><span class="emoji-item">🤨</span><span class="emoji-item">🧐</span><span class="emoji-item">🤓</span><span class="emoji-item">😎</span>
                                </div>
                            </div>
                            <div class="emoji-section" id="quickSection">
                                <div class="quick-message-list">
                                    <button class="quick-message-btn">안녕하세요</button>
                                    <button class="quick-message-btn">반갑습니다</button>
                                    <button class="quick-message-btn">잘 두셨습니다</button>
                                    <button class="quick-message-btn">감사합니다</button>
                                    <button class="quick-message-btn">수고하셨습니다</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/modal.js"></script>
    <script>
        const socket = io({
            withCredentials: true,
            transports: ['websocket', 'polling']
        });
        const currentUserId = '<%= user.id %>';
        const currentUserNickname = '<%= user.nickname %>';
        let currentUserStatus = 'waiting';
        let isMatching = false;
        let selectedTargetUser = null;
        let selectedMode = 'CLASSIC';
        let statsModalOpen = false;
        let aiBattleModalOpen = false;

        const STRATEGY_MODES = [
            { id: 'CLASSIC', name: '클래식바둑' },
            { id: 'CAPTURE', name: '캡처바둑' },
            { id: 'SPEED', name: '스피드바둑' },
            { id: 'BASE', name: '베이스바둑' },
            { id: 'HIDDEN', name: '히든바둑' },
            { id: 'MISSILE', name: '미사일바둑' },
            { id: 'MIX', name: '믹스바둑' }
        ];

        const CASUAL_MODES = [
            { id: 'DICE', name: '바둑주사위' },
            { id: 'COPS', name: '포졸바둑' },
            { id: 'OMOK', name: '오목' },
            { id: 'TTAK', name: '바둑딱지' },
            { id: 'ALKKAGI', name: '알까기' },
            { id: 'CURLING', name: '바둑컬링' }
        ];

        function openGameRequestModal(targetUser = null) {
            console.log('=== openGameRequestModal START ===', targetUser);
            try {
                selectedTargetUser = targetUser;
                const modal = document.getElementById('gameRequestModal');
                if (!modal) {
                    console.error('CRITICAL: gameRequestModal element NOT FOUND!');
                    alert('모달 요소를 찾을 수 없습니다. 페이지를 새로고침해주세요.');
                    return;
                }
                console.log('Modal element found:', modal);

                const titleEl = document.getElementById('requestModalTitle');
                const targetInfoEl = document.getElementById('targetUserInfo');
                const aiSection = document.getElementById('aiLevelSection');
                const messageSection = document.getElementById('messageSection');
                const categoryTitle = document.getElementById('requestCategoryTitle');
                const modeList = document.getElementById('requestModeList');

                if (!titleEl || !modeList) {
                    console.error('Required modal elements not found');
                    return;
                }

                const currentRoomType = '<%= typeof roomType !== "undefined" ? roomType : "strategy" %>';
                titleEl.textContent = targetUser ? '대국 신청' : 'AI봇 대결 설정';
                if (categoryTitle) categoryTitle.textContent = currentRoomType === 'strategy' ? '전략바둑' : '놀이바둑';
                
                const rightPanel = document.getElementById('requestRightPanel');
                
                if (targetUser) {
                    // 우측 패널 표시
                    if (rightPanel) rightPanel.style.display = 'flex';
                    
                    // 상대 프로필 정보 업데이트
                    const avatarEl = document.getElementById('targetUserAvatar');
                    const nicknameEl = document.getElementById('targetUserNickname');
                    const ratingEl = document.getElementById('targetUserRating');
                    if (avatarEl) avatarEl.textContent = targetUser.nickname ? targetUser.nickname.charAt(0).toUpperCase() : '?';
                    if (nicknameEl) nicknameEl.textContent = targetUser.nickname || '알 수 없음';
                    if (ratingEl) ratingEl.textContent = `레이팅: ${targetUser.rating || 0}`;
                    
                    // 선택된 게임 모드의 전적 업데이트
                    updateTargetUserStats(selectedMode);
                    
                    if (aiSection) aiSection.style.display = 'none';
                    if (messageSection) messageSection.style.display = 'flex';
                } else {
                    // AI 대결 모드일 때는 우측 패널 숨김
                    if (rightPanel) rightPanel.style.display = 'none';
                    if (aiSection) aiSection.style.display = 'block';
                    if (messageSection) messageSection.style.display = 'none';
                }

                const modes = currentRoomType === 'strategy' ? STRATEGY_MODES : CASUAL_MODES;
                selectedMode = modes[0] ? modes[0].id : 'CLASSIC';
                
                modeList.innerHTML = modes.map(mode => `
                    <button class="request-mode-item ${mode.id === selectedMode ? 'active' : ''}" 
                            onclick="selectRequestMode('${mode.id}')" data-mode="${mode.id}">
                        ${mode.name}
                    </button>
                `).join('');

                // 초기 모드 설정 업데이트
                updateModeSpecificSettings(selectedMode);
                if (targetUser) {
                    updateTargetUserStats(selectedMode);
                }

                console.log('Applying modal styles...');
                // 모든 가능한 방법으로 모달 표시
                modal.style.setProperty('display', 'flex', 'important');
                modal.style.setProperty('visibility', 'visible', 'important');
                modal.style.setProperty('opacity', '1', 'important');
                modal.style.setProperty('z-index', '100000', 'important');
                modal.classList.add('show');
                
                // 내부 컨텐츠도 확인
                const content = modal.querySelector('.stats-modal-content');
                if (content) {
                    content.style.setProperty('display', 'block', 'important');
                    content.style.setProperty('visibility', 'visible', 'important');
                    content.style.setProperty('opacity', '1', 'important');
                }
                
                aiBattleModalOpen = true;
                document.body.style.overflow = 'hidden';
                
                console.log('Modal should be visible now. Modal classes:', modal.className);
                console.log('Modal computed style display:', window.getComputedStyle(modal).display);
                console.log('=== openGameRequestModal END ===');
            } catch (error) {
                console.error('CRITICAL ERROR in openGameRequestModal:', error);
                alert('모달을 여는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function selectRequestMode(modeId) {
            selectedMode = modeId;
            document.querySelectorAll('.request-mode-item').forEach(el => {
                el.classList.toggle('active', el.dataset.mode === modeId);
            });
            
            // 게임 모드 변경 시 상대 전적 업데이트
            if (selectedTargetUser) {
                updateTargetUserStats(modeId);
            }
            
            // 게임 모드별 설정 업데이트
            updateModeSpecificSettings(modeId);
        }

        function updateTargetUserStats(modeId) {
            if (!selectedTargetUser) return;
            
            // 게임 모드 이름 찾기
            const currentRoomType = '<%= typeof roomType !== "undefined" ? roomType : "strategy" %>';
            const modes = currentRoomType === 'strategy' ? STRATEGY_MODES : CASUAL_MODES;
            const mode = modes.find(m => m.id === modeId);
            const modeName = mode ? mode.name : '게임';
            
            // 전적 제목 업데이트
            const statsTitleEl = document.getElementById('targetGameStatsTitle');
            if (statsTitleEl) statsTitleEl.textContent = `${modeName} 전적`;
            
            // TODO: 서버에서 실제 전적 데이터를 가져와서 표시
            // 현재는 임시로 0으로 표시
            const winsEl = document.getElementById('targetGameWins');
            const lossesEl = document.getElementById('targetGameLosses');
            const winRateEl = document.getElementById('targetGameWinRate');
            
            if (winsEl) winsEl.textContent = '0';
            if (lossesEl) lossesEl.textContent = '0';
            if (winRateEl) winRateEl.textContent = '0%';
            
            // 서버에서 전적 데이터 요청
            if (selectedTargetUser.id) {
                socket.emit('get_user_game_stats', {
                    userId: selectedTargetUser.id,
                    mode: modeId
                });
            }
        }

        function updateModeSpecificSettings(modeId) {
            const settingsContainer = document.getElementById('modeSpecificSettings');
            if (!settingsContainer) return;

            // 게임 모드별 특정 설정
            let settingsHTML = '';
            
            switch(modeId) {
                case 'SPEED':
                    settingsHTML = `
                        <label class="ai-battle-label">시간 제한</label>
                        <select id="timeLimitSelect" class="form-select">
                            <option value="300">5분 (빠른 대국)</option>
                            <option value="600">10분 (표준)</option>
                            <option value="900">15분 (여유)</option>
                        </select>
                    `;
                    settingsContainer.style.display = 'flex';
                    break;
                case 'BASE':
                    settingsHTML = `
                        <label class="ai-battle-label">베이스 개수</label>
                        <select id="baseCountSelect" class="form-select">
                            <option value="3">3개</option>
                            <option value="5">5개</option>
                            <option value="7">7개</option>
                        </select>
                    `;
                    settingsContainer.style.display = 'flex';
                    break;
                case 'HIDDEN':
                    settingsHTML = `
                        <label class="ai-battle-label">히든 돌 개수</label>
                        <select id="hiddenCountSelect" class="form-select">
                            <option value="5">5개</option>
                            <option value="10">10개</option>
                            <option value="15">15개</option>
                        </select>
                    `;
                    settingsContainer.style.display = 'flex';
                    break;
                default:
                    settingsContainer.style.display = 'none';
                    break;
            }
            
            settingsContainer.innerHTML = settingsHTML;
        }

        // 서버에서 전적 데이터 수신
        socket.on('user_game_stats', (data) => {
            if (data && data.userId === selectedTargetUser?.id && data.mode === selectedMode) {
                const wins = data.wins || 0;
                const losses = data.losses || 0;
                const total = wins + losses;
                const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
                
                const winsEl = document.getElementById('targetGameWins');
                const lossesEl = document.getElementById('targetGameLosses');
                const winRateEl = document.getElementById('targetGameWinRate');
                
                if (winsEl) winsEl.textContent = wins;
                if (lossesEl) lossesEl.textContent = losses;
                if (winRateEl) winRateEl.textContent = `${winRate}%`;
            }
        });

        function closeGameRequestModal() {
            console.log('closeGameRequestModal called');
            const modal = document.getElementById('gameRequestModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.setProperty('display', 'none', 'important');
                modal.style.setProperty('visibility', 'hidden', 'important');
                modal.style.setProperty('opacity', '0', 'important');
                aiBattleModalOpen = false;
                document.body.style.overflow = '';
            }
        }

        // DOM 로드 후 모달 이벤트 리스너 설정
        function setupModalEventListeners() {
            // 모달 배경 클릭 시 닫기
            const gameRequestModal = document.getElementById('gameRequestModal');
            if (gameRequestModal) {
                gameRequestModal.addEventListener('click', function(e) {
                    if (e.target === this || e.target.id === 'gameRequestModal') {
                        console.log('Modal background clicked, closing modal');
                        closeGameRequestModal();
                    }
                });
            }

            // ESC 키로 모달 닫기
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && aiBattleModalOpen) {
                    console.log('ESC key pressed, closing AI Battle modal');
                    closeGameRequestModal();
                }
            });
        }

        // DOM 로드 완료 후 실행
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupModalEventListeners);
        } else {
            setupModalEventListeners();
        }

        function showAiBattleModal() {
            console.log('showAiBattleModal called');
            try {
                openGameRequestModal(null);
            } catch (error) {
                console.error('Error in showAiBattleModal:', error);
                alert('모달을 여는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function closeAiBattleModal() {
            closeGameRequestModal();
        }

        document.getElementById('confirmRequestBtn')?.addEventListener('click', () => {
            const komi = parseFloat(document.getElementById('komiSelect').value);
            const color = document.querySelector('.ai-color-btn.active').dataset.color;
            
            if (selectedTargetUser) {
                const message = document.getElementById('requestMessage').value;
                socket.emit('send_game_request', {
                    targetUserId: selectedTargetUser.id,
                    mode: selectedMode,
                    komi: komi,
                    message: message
                });
                alert('대국 신청을 보냈습니다.');
                closeGameRequestModal();
            } else {
                const level = parseInt(document.querySelector('.ai-level-btn.active').dataset.level);
                socket.emit('start_ai_game', {
                    level: level,
                    color: color,
                    mode: selectedMode,
                    komi: komi
                });
                closeGameRequestModal();
            }
        });

        // Event Delegation for buttons (간단하고 안전한 방식)
        document.addEventListener('click', (e) => {
            const target = e.target;
            
            if (target.id === 'aiBattleBtn' || target.closest('#aiBattleBtn')) {
                console.log('AI Battle button clicked!');
                e.preventDefault();
                e.stopPropagation();
                showAiBattleModal();
                return false;
            } else if (target.id === 'detailBtn' || target.closest('#detailBtn')) {
                showStatsModal();
            } else if (target.classList.contains('ai-level-btn')) {
                document.querySelectorAll('.ai-level-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
            } else if (target.classList.contains('ai-color-btn')) {
                document.querySelectorAll('.ai-color-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
            }
        });

        socket.on('connect', () => {
            const roomType = '<%= typeof roomType !== "undefined" ? roomType : "strategy" %>';
            socket.emit('join_waiting_room', roomType);
            socket.emit('get_user_list', roomType);
            socket.emit('get_ongoing_games');
            socket.emit('get_rankings');
        });

        socket.on('user_list_update', (users) => {
            renderOnlineUsers(users);
        });

        socket.on('rankings_update', (rankings) => {
            renderRankings(rankings);
        });

        socket.on('ongoing_games_update', (games) => {
            renderOngoingGames(games);
        });

        socket.on('game_started', (data) => {
            window.location.href = `/api/game/${data.gameId}`;
        });

        // 유틸리티 함수들
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            
            // KST (UTC+9)로 변환
            const kstOffset = 9 * 60; // 한국은 UTC+9
            const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
            const kstDate = new Date(utc + (kstOffset * 60000));
            
            // 시간 포맷: HH:MM
            const hours = String(kstDate.getHours()).padStart(2, '0');
            const minutes = String(kstDate.getMinutes()).padStart(2, '0');
            
            return `${hours}:${minutes}`;
        }

        function addChatMessage(user, message, timestamp, roomType) {
            const list = document.getElementById('chatMessages');
            if (!list) return;
            const roomTypeText = roomType === 'casual' ? '[놀이]' : '[전략]';
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-user">${roomTypeText} ${escapeHtml(user)}</span>
                    <span class="message-content">${escapeHtml(message)}</span>
                    <span class="message-time">${formatTime(timestamp)}</span>
                </div>
            `;
            list.appendChild(messageDiv);
            list.scrollTop = list.scrollHeight;
        }

        socket.on('ai_game_started', (data) => {
            window.location.href = `/api/game/${data.gameId}`;
        });

        socket.on('chat_message', (data) => {
            if (data && data.user && data.message) {
                addChatMessage(data.user, data.message, data.timestamp, data.roomType);
            }
        });

        function renderOnlineUsers(users) {
            const list = document.getElementById('onlineUsersList');
            if (!list) return;

            let html = `
                <div class="current-user-item">
                    <div class="user-info">
                        <div class="user-avatar">${currentUserNickname.charAt(0).toUpperCase()}</div>
                        <div class="user-nickname">${currentUserNickname} (나)</div>
                    </div>
                    <select class="status-dropdown" id="statusDropdown" onchange="changeStatus(this.value)">
                        <option value="waiting" ${currentUserStatus === 'waiting' ? 'selected' : ''}>대기중</option>
                        <option value="resting" ${currentUserStatus === 'resting' ? 'selected' : ''}>휴식중</option>
                    </select>
                </div>
            `;

            html += users.filter(u => u.id !== currentUserId).map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">${user.nickname.charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <div class="user-nickname">${user.nickname}</div>
                            <div class="user-rating">레이팅: ${user.rating}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="user-status-badge status-${user.status || 'waiting'}">${getStatusText(user.status || 'waiting')}</div>
                        <button class="btn btn-primary" style="font-size: 12px; padding: 4px 8px;" onclick="openGameRequestModal({id: '${user.id}', nickname: '${user.nickname}', rating: ${user.rating}})">대국신청</button>
                    </div>
                </div>
            `).join('');
            
            list.innerHTML = html;
        }

        function getStatusText(status) {
            const statusMap = {
                'waiting': '대기 중',
                'resting': '휴식 중',
                'matching': '매칭 중',
                'in-game': '대국 중',
                'spectating': '관전 중'
            };
            return statusMap[status] || status;
        }

        function changeStatus(newStatus) {
            if (isMatching) {
                alert('매칭 중에는 상태를 변경할 수 없습니다.');
                return;
            }
            socket.emit('change_status', { status: newStatus });
        }

        socket.on('status_changed', (data) => {
            if (data.userId === currentUserId) {
                currentUserStatus = data.status;
                const dropdown = document.getElementById('statusDropdown');
                if (dropdown) dropdown.value = data.status;
            }
        });

        function renderOngoingGames(games) {
            const list = document.getElementById('ongoingGamesList');
            if (!list) return;
            if (games.length === 0) {
                list.innerHTML = '<div class="empty-state">진행 중인 게임이 없습니다.</div>';
                return;
            }
            list.innerHTML = games.map((game, index) => {
                const roomNumber = game.roomNumber || (index + 1);
                const title = game.title || '랜덤 대결';
                const blackPlayer = game.blackPlayer || { nickname: 'Unknown', rating: 0 };
                const whitePlayer = game.whitePlayer || { nickname: 'Unknown', rating: 0 };
                
                return `
                    <div class="game-item">
                        <div class="game-room-number-badge">${roomNumber}</div>
                        <div class="game-info">
                            <div class="game-title">${escapeHtml(title)}</div>
                        </div>
                        <div class="game-players">
                            <div class="player-info">
                                <div class="player-stone black">●</div>
                                <div class="player-details">
                                    <div class="player-name">${escapeHtml(blackPlayer.nickname)}</div>
                                    <div class="player-rating">${blackPlayer.rating || 0}</div>
                                </div>
                            </div>
                            <span class="vs-divider">VS</span>
                            <div class="player-info">
                                <div class="player-details">
                                    <div class="player-name">${escapeHtml(whitePlayer.nickname)}</div>
                                    <div class="player-rating">${whitePlayer.rating || 0}</div>
                                </div>
                                <div class="player-stone white">○</div>
                            </div>
                        </div>
                        <button class="watch-btn" onclick="event.stopPropagation(); window.location.href='/api/game/${game.id}'">관전</button>
                    </div>
                `;
            }).join('');
        }

        function renderRankings(rankings) {
            const list = document.getElementById('rankingList');
            if (!list) return;
            
            // 현재 사용자의 랭킹 찾기
            const myRanking = rankings.find(r => r.userId === currentUserId || r.nickname === currentUserNickname);
            const otherRankings = rankings.filter(r => r.userId !== currentUserId && r.nickname !== currentUserNickname);
            
            let html = '';
            
            // 나의 랭킹을 맨 위에 표시
            if (myRanking) {
                const myRankIndex = rankings.findIndex(r => r.userId === currentUserId || r.nickname === currentUserNickname);
                html += `
                    <div class="my-ranking-item">
                        <div class="rank-number">${myRankIndex >= 0 ? myRankIndex + 1 : '-'}</div>
                        <div class="ranking-user-info">
                            <div class="ranking-nickname">${escapeHtml(myRanking.nickname)} (나)</div>
                            <div class="ranking-stats">${myRanking.wins || 0}승 ${myRanking.losses || 0}패</div>
                        </div>
                        <div class="ranking-rating">${myRanking.rating || 0}</div>
                    </div>
                `;
            } else {
                // 랭킹 목록에 없으면 현재 사용자 정보로 표시
                html += `
                    <div class="my-ranking-item">
                        <div class="rank-number">-</div>
                        <div class="ranking-user-info">
                            <div class="ranking-nickname">${escapeHtml(currentUserNickname)} (나)</div>
                            <div class="ranking-stats">${currentUserWins}승 ${currentUserLosses}패</div>
                        </div>
                        <div class="ranking-rating">${currentUserRating}</div>
                    </div>
                `;
            }
            
            // 나머지 랭킹 표시
            html += otherRankings.map((rank) => {
                const actualRank = rankings.findIndex(r => r.userId === rank.userId || r.nickname === rank.nickname) + 1;
                return `
                    <div class="ranking-item">
                        <div class="rank-number">${actualRank}</div>
                        <div class="ranking-user-info">
                            <div class="ranking-nickname">${escapeHtml(rank.nickname)}</div>
                            <div class="ranking-stats">${rank.wins || 0}승 ${rank.losses || 0}패</div>
                        </div>
                        <div class="ranking-rating">${rank.rating || 0}</div>
                    </div>
                `;
            }).join('');
            
            list.innerHTML = html;
        }

        // Stats Modal Logic (Simplified for brevity)
        function showStatsModal() {
            const modal = document.getElementById('statsModal');
            if (modal) {
                modal.classList.add('show');
                statsModalOpen = true;
                document.body.style.overflow = 'hidden';
            }
        }

        function closeStatsModal() {
            const modal = document.getElementById('statsModal');
            if (modal) {
                modal.classList.remove('show');
                statsModalOpen = false;
                document.body.style.overflow = '';
            }
        }

        document.getElementById('closeStatsModalBtn')?.addEventListener('click', closeStatsModal);
        
        // Tab switching
        function switchStatsTab(tabName) {
            document.querySelectorAll('.stats-tab').forEach(t => t.classList.toggle('active', t.textContent.includes(tabName === 'strategy' ? '전략' : '놀이')));
            document.querySelectorAll('.stats-tab-content').forEach(c => c.classList.toggle('active', c.id === tabName + 'Tab'));
        }

        // Layout Scaling
        let isScaling = false;
        function scaleLayout() {
            const container = document.querySelector('.container');
            if (!container || isScaling) return;
            
            isScaling = true;
            container.style.transform = 'scale(1)';
            container.style.width = '1600px';
            
            const baseWidth = 1600;
            const scrollHeight = container.scrollHeight;
            const offsetHeight = container.offsetHeight;
            const actualHeight = Math.max(scrollHeight, offsetHeight);
            const baseHeight = Math.max(actualHeight, 800);
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            const minScale = 0.3;
            const maxScale = 1.0;
            
            const header = document.querySelector('header');
            const headerHeight = header ? header.offsetHeight : 80;
            const padding = 40;
            const availableWidth = Math.max(viewportWidth - padding, baseWidth * minScale);
            const availableHeight = Math.max(viewportHeight - headerHeight - padding - 20, baseHeight * minScale);
            
            const scaleX = availableWidth / baseWidth;
            const scaleY = availableHeight / baseHeight;
            let scale = Math.min(scaleX, scaleY);
            scale = Math.max(Math.min(scale, maxScale), minScale);
            
            container.style.transform = `scale(${scale})`;
            container.style.transformOrigin = 'top center';
            container.style.width = `${baseWidth}px`;
            
            const scaledHeight = baseHeight * scale;
            const totalHeight = scaledHeight + headerHeight + 100;
            document.body.style.minHeight = `${Math.max(totalHeight, viewportHeight)}px`;
            
            isScaling = false;
        }

        const observer = new MutationObserver((mutations) => {
            if (isScaling) return;
            let shouldIgnore = false;
            for (const mutation of mutations) {
                const target = mutation.target;
                if (target && (
                    target.id === 'emojiPopup' || target.closest('#emojiPopup') ||
                    target.id === 'statsModal' || target.closest('#statsModal') ||
                    target.id === 'gameRequestModal' || target.closest('#gameRequestModal') ||
                    target.closest('.stats-modal')
                )) {
                    shouldIgnore = true;
                    break;
                }
            }
            if (!shouldIgnore) scaleLayout();
        });
        
        const container = document.querySelector('.container');
        if (container) {
            observer.observe(container, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['class']
            });
        }

        window.addEventListener('resize', scaleLayout);
        window.addEventListener('load', scaleLayout);
        scaleLayout();

        // 채팅 이벤트 리스너 설정
        function setupChatListeners() {
            const emojiBtn = document.getElementById('emojiBtn');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatInput = document.getElementById('chatInput');
            const emojiPopup = document.getElementById('emojiPopup');
            const emojiTabs = document.querySelectorAll('.emoji-tab');
            const emojiItems = document.querySelectorAll('.emoji-item');
            const quickMessageBtns = document.querySelectorAll('.quick-message-btn');

            // 이모지 버튼 클릭
            if (emojiBtn) {
                emojiBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (emojiPopup) {
                        emojiPopup.classList.toggle('show');
                    }
                });
            }

            // 이모지 팝업 외부 클릭 시 닫기
            document.addEventListener('click', function(e) {
                if (emojiPopup && !emojiPopup.contains(e.target) && e.target !== emojiBtn) {
                    emojiPopup.classList.remove('show');
                }
            });

            // 이모지 탭 전환
            emojiTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    emojiTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.emoji-section').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    const section = tabName === 'emoji' ? document.getElementById('emojiSection') : document.getElementById('quickSection');
                    if (section) section.classList.add('active');
                });
            });

            // 이모지 클릭
            emojiItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (chatInput) {
                        chatInput.value += this.textContent;
                        chatInput.focus();
                    }
                });
            });

            // 퀵 메시지 클릭
            quickMessageBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (chatInput) {
                        chatInput.value = this.textContent;
                        chatInput.focus();
                    }
                });
            });

            // 메시지 전송
            function sendChatMessage() {
                if (!chatInput || !chatInput.value.trim()) {
                    console.log('Message is empty or chatInput not found');
                    return;
                }
                
                const message = chatInput.value.trim();
                console.log('Sending chat message:', message);
                
                // 서버는 'chat_message' 이벤트를 받습니다
                socket.emit('chat_message', {
                    message: message,
                    timestamp: Date.now()
                });
                
                chatInput.value = '';
                if (emojiPopup) emojiPopup.classList.remove('show');
            }

            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', sendChatMessage);
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        }

        // DOM 로드 후 채팅 리스너 설정
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupChatListeners);
        } else {
            setupChatListeners();
        }
    </script>
</body>
</html>
