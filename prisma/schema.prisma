// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GameMode {
  STRATEGY  // 전략바둑
  PLAY      // 놀이바둑
}

enum GameStatus {
  WAITING
  IN_PROGRESS
  FINISHED
  ABANDONED
}

enum GameResult {
  PLAYER1_WIN
  PLAYER2_WIN
  DRAW
  TIMEOUT
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  PLAYING      // 경기중
  RESTING      // 휴식중
  WAITING      // 대기중
  SPECTATING   // 관전중
}

model User {
  id                String      @id @default(cuid())
  email             String      @unique
  username          String      @unique
  passwordHash      String
  role              UserRole    @default(USER)
  nickname          String?     @unique // 한글 닉네임 (1-6자)
  avatarId          String?     // 기본 아바타 ID
  hasCompletedSetup Boolean     @default(false) // 닉네임/아바타 설정 완료 여부
  status            UserStatus  @default(WAITING)
  gold              Int         @default(0) // 골드 (재화)
  gameTickets       Int         @default(10) // 대국 이용권 (최대 10개)
  lastTicketRecovery DateTime? // 마지막 이용권 회복 시간
  createdAt         DateTime    @default(now())
  
  gamesAsPlayer1    Game[]  @relation("Player1Games")
  gamesAsPlayer2    Game[]  @relation("Player2Games")
  ratings           Rating[]
  sessions          Session[]
  spectating        Spectator[]
  aiProgress        AIProgress?
  gameRequestsSent  GameRequest[] @relation("RequestSender")
  gameRequestsReceived GameRequest[] @relation("RequestReceiver")
  gameStats         GameStats[]
  chatMessages      ChatMessage[]
  rankingMatchQueue RankingMatchQueue?
}

model Game {
  id            String      @id @default(cuid())
  mode          GameMode
  season        Int         // 시즌 번호
  gameType      String?     // 전략바둑/놀이바둑 종류 (CLASSIC, CAPTURE, SPEED, BASE, HIDDEN, MISSILE, MIXED, OMOK, TTAMOK, DICE, THIEF_COP, ALKKAGI, CURLING)
  boardSize     Int?        // 9, 13, 19
  gameRules     Json?       // 각 게임 타입별 특수 규칙
  player1Id     String
  player2Id     String?
  aiType        String?     // "gnugo", null (KataGo는 대결에 사용 안 함)
  aiLevel       Int?         // GnuGo 난이도 (1-10)
  status        GameStatus  @default(WAITING)
  moves         Json        @default("[]") // 수순 기록
  boardState    Json?       // 현재 바둑판 상태
  timeLimit     Int         // 초 단위
  player1Time   Int         // 남은 시간 (초)
  player2Time   Int?        // 남은 시간 (초)
  currentPlayer Int         @default(1) // 1 or 2
  winnerId      String?
  result        GameResult?
  createdAt     DateTime    @default(now())
  startedAt     DateTime?
  finishedAt    DateTime?
  
  player1       User        @relation("Player1Games", fields: [player1Id], references: [id])
  player2       User?        @relation("Player2Games", fields: [player2Id], references: [id])
  spectators    Spectator[]
  chatMessages  ChatMessage[]
  
  @@index([status])
  @@index([season, mode])
  @@index([gameType])
}

model Rating {
  id            String   @id @default(cuid())
  userId        String
  season        Int
  mode          GameMode
  rating        Int      @default(1500)
  wins          Int      @default(0)
  losses        Int      @default(0)
  draws         Int      @default(0)
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, season, mode])
  @@index([season, mode, rating])
}

model Session {
  id            String   @id @default(cuid())
  userId        String
  socketId      String   @unique
  isOnline      Boolean  @default(true)
  lastSeen      DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([isOnline])
}

model Spectator {
  id            String   @id @default(cuid())
  gameId        String
  userId        String
  joinedAt      DateTime @default(now())
  
  game          Game     @relation(fields: [gameId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  
  @@unique([gameId, userId])
  @@index([gameId])
}

model AIProgress {
  id            String   @id @default(cuid())
  userId        String   @unique
  currentLevel  Int      @default(1) // 1-10 단계
  highestLevel  Int      @default(1)
  wins          Int      @default(0)
  losses        Int      @default(0)
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
}

enum GameRequestStatus {
  PENDING     // 대기중
  ACCEPTED    // 수락됨
  REJECTED    // 거절됨
  MODIFIED    // 수정 제안됨
  CANCELLED   // 취소됨
}

model GameRequest {
  id            String            @id @default(cuid())
  senderId      String            // 신청자
  receiverId    String            // 수신자
  gameType      String            // 게임 타입
  boardSize     Int               // 보드 크기
  timeLimit     Int               @default(1800) // 시간 제한 (초)
  status        GameRequestStatus @default(PENDING)
  modifiedConditions Json?        // 수정 제안된 조건
  createdAt     DateTime          @default(now())
  respondedAt   DateTime?
  
  sender        User              @relation("RequestSender", fields: [senderId], references: [id])
  receiver      User              @relation("RequestReceiver", fields: [receiverId], references: [id])
  
  @@index([senderId])
  @@index([receiverId, status])
}

model GameStats {
  id            String   @id @default(cuid())
  userId        String
  gameType      String   // 게임 타입 (CLASSIC, OMOK 등)
  mode          GameMode // STRATEGY or PLAY
  wins          Int      @default(0)
  losses        Int      @default(0)
  draws         Int      @default(0)
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, gameType])
  @@index([userId])
}

enum ChatType {
  GLOBAL    // 전체 채팅
  GAME      // 대국실 채팅
}

model ChatMessage {
  id            String   @id @default(cuid())
  userId        String
  gameId        String?  // 대국실 채팅인 경우
  type          ChatType @default(GLOBAL)
  message       String
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id])
  game          Game?    @relation(fields: [gameId], references: [id])
  
  @@index([type, createdAt])
  @@index([gameId, createdAt])
}

model RankingMatchQueue {
  id            String   @id @default(cuid())
  userId        String   @unique
  gameType      String   // 게임 타입
  boardSize     Int      // 보드 크기
  rating        Int      // 현재 랭킹점수
  joinedAt      DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id])
  
  @@index([gameType, boardSize, rating])
  @@index([joinedAt])
}

